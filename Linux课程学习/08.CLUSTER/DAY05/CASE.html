
<!-- saved from url=(0078)http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>CASE</title>
    
    <script type="text/javascript" src="./CASE_files/jquery.min.js">
    </script>
    <script type="text/javascript" src="./CASE_files/jquery.snippet.js">
    </script>
    <script type="text/javascript" src="./CASE_files/main.js">
    </script>
    <link type="text/css" href="./CASE_files/index.css" rel="Stylesheet">
    <link type="text/css" href="./CASE_files/jquery.snippet.css" rel="Stylesheet">
  </head>
  <body>
    <div class="source_style_case">
      <a name="page_top_case" id="top_anchor">
      </a><a id="link_top" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#page_top_case">Top</a>
      <h1>NSD CLUSTER DAY05</h1>
      <ol class="index">
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#case1">案例1：块存储应用案例</a>
        </li>
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#case2">案例2：Ceph文件系统</a>
        </li>
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#case3">案例3：创建对象存储服务器</a>
        </li>
      </ol>
      <a name="case1">
      </a>
      <h2>1 案例1：块存储应用案例</h2>
      <h3>1.1 问题</h3>
      <p>延续Day04的实验内容，演示块存储在KVM虚拟化中的应用案例，实现以下功能：</p>
      <ul class="list">
        <li>Ceph创建块存储镜像
</li>
        <li>客户端安装部署ceph软件
</li>
        <li>客户端部署虚拟机
</li>
        <li>客户端创建secret
</li>
        <li>设置虚拟机配置文件，调用ceph存储
</li>
      </ul>
      <h3>1.2 方案</h3>
      <p>使用Ceph存储创建镜像。</p>
      <p>KVM虚拟机调用Ceph镜像作为虚拟机的磁盘。</p>
      <h3>1.3 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p>1）创建磁盘镜像。</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@node1 <span class="sh_symbol">~]</span># rbd create vm1<span class="sh_symbol">-</span>image <span class="sh_symbol">--</span>image<span class="sh_symbol">-</span>feature  layering <span class="sh_symbol">--</span>size 10G</li><li><span class="sh_symbol">[</span>root@node1 <span class="sh_symbol">~]</span># rbd create vm2<span class="sh_symbol">-</span>image <span class="sh_symbol">--</span>image<span class="sh_symbol">-</span>feature  layering <span class="sh_symbol">--</span>size 10G</li><li><span class="sh_symbol">[</span>root@node1 <span class="sh_symbol">~]</span># rbd  list</li><li><span class="sh_symbol">[</span>root@node1 <span class="sh_symbol">~]</span># rbd  info  vm1<span class="sh_symbol">-</span>image</li><li><span class="sh_symbol">[</span>root@node1 <span class="sh_symbol">~]</span># qemu<span class="sh_symbol">-</span>img  info  rbd<span class="sh_symbol">:</span><span class="sh_normal">rbd</span><span class="sh_symbol">/</span>vm1<span class="sh_symbol">-</span>image</li><li>image<span class="sh_symbol">:</span> rbd<span class="sh_symbol">:</span><span class="sh_normal">rbd</span><span class="sh_symbol">/</span>vm1<span class="sh_symbol">-</span>image</li><li>file format<span class="sh_symbol">:</span> raw</li><li>virtual size<span class="sh_symbol">:</span> 10<span class="sh_function">G</span> <span class="sh_symbol">(</span><span class="sh_number">10737418240</span> bytes<span class="sh_symbol">)</span></li><li>disk size<span class="sh_symbol">:</span> unavailable</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@node1 ~]# rbd create vm1-image --image-feature  layering --size 10G
[root@node1 ~]# rbd create vm2-image --image-feature  layering --size 10G
[root@node1 ~]# rbd  list
[root@node1 ~]# rbd  info  vm1-image
[root@node1 ~]# qemu-img  info  rbd:rbd/vm1-image
image: rbd:rbd/vm1-image
file format: raw
virtual size: 10G (10737418240 bytes)
disk size: unavailable
</pre></div></div>
      <p>2）Ceph认证账户。</p>
      <p>Ceph默认开启用户认证，客户端需要账户才可以访问，</p>
      <p>默认账户名称为client.admin，key是账户的密钥，</p>
      <p>可以使用ceph auth添加新账户（案例我们使用默认账户）。</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@node1 <span class="sh_symbol">~]</span># <span class="sh_normal">cat </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span><span class="sh_normal">ceph</span><span class="sh_symbol">/</span>ceph<span class="sh_symbol">.</span>conf          <span class="sh_comment">//配置文件 </span></li><li><span class="sh_symbol">[</span>global<span class="sh_symbol">]</span></li><li>mon_initial_members <span class="sh_symbol">=</span> node1<span class="sh_symbol">,</span> node2<span class="sh_symbol">,</span> node3</li><li>mon_host <span class="sh_symbol">=</span> <span class="sh_number">192.168.2.10</span><span class="sh_symbol">,</span><span class="sh_number">192.168.2.20</span><span class="sh_symbol">,</span><span class="sh_number">192.168.2.30</span></li><li>auth_cluster_required <span class="sh_symbol">=</span> cephx                                   <span class="sh_comment">//开启认证</span></li><li>auth_service_required <span class="sh_symbol">=</span> cephx                           <span class="sh_comment">//开启认证</span></li><li>auth_client_required <span class="sh_symbol">=</span> cephx                             <span class="sh_comment">//开启认证</span></li><li><span class="sh_symbol">[</span>root@node1 <span class="sh_symbol">~]</span># <span class="sh_normal">cat </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span><span class="sh_normal">ceph</span><span class="sh_symbol">/</span>ceph<span class="sh_symbol">.</span>client<span class="sh_symbol">.</span>admin<span class="sh_symbol">.</span>keyring    <span class="sh_comment">//账户文件</span></li><li><span class="sh_symbol">[</span>client<span class="sh_symbol">.</span>admin<span class="sh_symbol">]</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;key <span class="sh_symbol">=</span> AQBTsdRapUxBKRAANXtteNUyoEmQHveb75bISg<span class="sh_symbol">==</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@node1 ~]# cat /etc/ceph/ceph.conf          //配置文件 
[global]
mon_initial_members = node1, node2, node3
mon_host = 192.168.2.10,192.168.2.20,192.168.2.30
auth_cluster_required = cephx                                   //开启认证
auth_service_required = cephx                           //开启认证
auth_client_required = cephx                             //开启认证
[root@node1 ~]# cat /etc/ceph/ceph.client.admin.keyring    //账户文件
[client.admin]
	key = AQBTsdRapUxBKRAANXtteNUyoEmQHveb75bISg==
</pre></div></div>
      <p>3）部署客户端环境。</p>
      <p>注意：这里使用真实机当客户端！！！</p>
      <p>客户端需要安装ceph-common软件包，拷贝配置文件（否则不知道集群在哪），</p>
      <p>拷贝连接密钥（否则无连接权限）。</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@room9pc01 <span class="sh_symbol">~]</span># yum <span class="sh_symbol">-</span>y  install ceph<span class="sh_symbol">-</span>common</li><li><span class="sh_symbol">[</span>root@room9pc01 <span class="sh_symbol">~]</span># scp <span class="sh_number">192.168.4.11</span><span class="sh_symbol">:</span><span class="sh_regexp">/etc/</span><span class="sh_normal">ceph</span><span class="sh_symbol">/</span>ceph<span class="sh_symbol">.</span><span class="sh_normal">conf  </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span><span class="sh_normal">ceph</span><span class="sh_symbol">/</span></li><li><span class="sh_symbol">[</span>root@room9pc01 <span class="sh_symbol">~]</span># scp <span class="sh_number">192.168.4.11</span><span class="sh_symbol">:</span><span class="sh_regexp">/etc/</span><span class="sh_normal">ceph</span><span class="sh_symbol">/</span>ceph<span class="sh_symbol">.</span>client<span class="sh_symbol">.</span>admin<span class="sh_symbol">.</span>keyring <span class="sh_symbol">\</span></li><li><span class="sh_regexp">/etc/</span><span class="sh_normal">ceph</span><span class="sh_symbol">/</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@room9pc01 ~]# yum -y  install ceph-common
[root@room9pc01 ~]# scp 192.168.4.11:/etc/ceph/ceph.conf  /etc/ceph/
[root@room9pc01 ~]# scp 192.168.4.11:/etc/ceph/ceph.client.admin.keyring \
/etc/ceph/
</pre></div></div>
      <p>4）创建KVM虚拟机。</p>
      <p>使用virt-manager创建2台普通的KVM虚拟机。</p>
      <p>5）配置libvirt secret。</p>
      <p>编写账户信息文件（真实机操作）</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@room9pc01 <span class="sh_symbol">~]</span># vim secret<span class="sh_symbol">.</span>xml            <span class="sh_comment">//新建临时文件，内容如下 </span></li><li><span class="sh_symbol">&lt;</span>secret ephemeral<span class="sh_symbol">=</span><span class="sh_string">'no'</span> <span class="sh_keyword">private</span><span class="sh_symbol">=</span><span class="sh_string">'no'</span><span class="sh_symbol">&gt;</span></li><li>        <span class="sh_symbol">&lt;</span>usage type<span class="sh_symbol">=</span><span class="sh_string">'ceph'</span><span class="sh_symbol">&gt;</span></li><li>                <span class="sh_symbol">&lt;</span>name<span class="sh_symbol">&gt;</span>client<span class="sh_symbol">.</span>admin secret<span class="sh_symbol">&lt;/</span>name<span class="sh_symbol">&gt;</span></li><li>        <span class="sh_symbol">&lt;/</span>usage<span class="sh_symbol">&gt;</span></li><li><span class="sh_symbol">&lt;/</span>secret<span class="sh_symbol">&gt;</span></li><li>#使用XML配置文件创建secret</li><li><span class="sh_symbol">[</span>root@room9pc01 <span class="sh_symbol">~]</span># virsh secret<span class="sh_symbol">-</span>define <span class="sh_symbol">--</span>file secret<span class="sh_symbol">.</span>xml</li><li>733f0fd1<span class="sh_symbol">-</span>e3d6<span class="sh_symbol">-</span>4c25<span class="sh_symbol">-</span>a69f<span class="sh_symbol">-</span>6681fc19802b       </li><li><span class="sh_comment">//随机的UUID，这个UUID对应的有账户信息</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@room9pc01 ~]# vim secret.xml            //新建临时文件，内容如下 
&lt;secret ephemeral='no' private='no'&gt;
        &lt;usage type='ceph'&gt;
                &lt;name&gt;client.admin secret&lt;/name&gt;
        &lt;/usage&gt;
&lt;/secret&gt;
#使用XML配置文件创建secret
[root@room9pc01 ~]# virsh secret-define --file secret.xml
733f0fd1-e3d6-4c25-a69f-6681fc19802b       
//随机的UUID，这个UUID对应的有账户信息
</pre></div></div>
      <p>编写账户信息文件（真实机操作）</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@room9pc01 <span class="sh_symbol">~]</span># <span class="sh_normal">cat </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span><span class="sh_normal">ceph</span><span class="sh_symbol">/</span>ceph<span class="sh_symbol">.</span>client<span class="sh_symbol">.</span>admin<span class="sh_symbol">.</span>keyring</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@room9pc01 ~]# cat /etc/ceph/ceph.client.admin.keyring
</pre></div></div>
      <p>设置secret，添加账户的密钥</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@room9pc01<span class="sh_symbol">]</span> virsh secret<span class="sh_symbol">-</span>set<span class="sh_symbol">-</span>value <span class="sh_symbol">\</span></li><li><span class="sh_symbol">--</span>secret 733f0fd1<span class="sh_symbol">-</span>e3d6<span class="sh_symbol">-</span>4c25<span class="sh_symbol">-</span>a69f<span class="sh_symbol">-</span>6681fc19802b <span class="sh_symbol">\</span></li><li><span class="sh_symbol">--</span>base64 AQBTsdRapUxBKRAANXtteNUyoEmQHveb75bISg</li><li><span class="sh_comment">//这里secret后面是之前创建的secret的UUID</span></li><li><span class="sh_comment">//base64后面是client.admin账户的密码</span></li><li><span class="sh_comment">//现在secret中既有账户信息又有密钥信息</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@room9pc01] virsh secret-set-value \
--secret 733f0fd1-e3d6-4c25-a69f-6681fc19802b \
--base64 AQBTsdRapUxBKRAANXtteNUyoEmQHveb75bISg
//这里secret后面是之前创建的secret的UUID
//base64后面是client.admin账户的密码
//现在secret中既有账户信息又有密钥信息
</pre></div></div>
      <p>6）虚拟机的XML配置文件。</p>
      <p>每个虚拟机都会有一个XML配置文件，包括：</p>
      <p>虚拟机的名称、内存、CPU、磁盘、网卡等信息</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@room9pc01 <span class="sh_symbol">~]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span><span class="sh_normal">libvirt</span><span class="sh_symbol">/</span><span class="sh_normal">qemu</span><span class="sh_symbol">/</span>vm1<span class="sh_symbol">.</span>xml</li><li><span class="sh_comment">//修改前内容如下</span></li><li><span class="sh_symbol">&lt;</span>disk type<span class="sh_symbol">=</span><span class="sh_string">'file'</span> device<span class="sh_symbol">=</span><span class="sh_string">'disk'</span><span class="sh_symbol">&gt;</span></li><li>      <span class="sh_symbol">&lt;</span>driver name<span class="sh_symbol">=</span><span class="sh_string">'qemu'</span> type<span class="sh_symbol">=</span><span class="sh_string">'qcow2'</span><span class="sh_symbol">/&gt;</span></li><li>      <span class="sh_symbol">&lt;</span>source file<span class="sh_symbol">=</span><span class="sh_string">'/var/lib/libvirt/images/vm1.qcow2'</span><span class="sh_symbol">/&gt;</span></li><li>      <span class="sh_symbol">&lt;</span>target dev<span class="sh_symbol">=</span><span class="sh_string">'vda'</span> bus<span class="sh_symbol">=</span><span class="sh_string">'virtio'</span><span class="sh_symbol">/&gt;</span></li><li>      <span class="sh_symbol">&lt;</span>address type<span class="sh_symbol">=</span><span class="sh_string">'pci'</span> domain<span class="sh_symbol">=</span><span class="sh_string">'0x0000'</span> bus<span class="sh_symbol">=</span><span class="sh_string">'0x00'</span> slot<span class="sh_symbol">=</span><span class="sh_string">'0x07'</span> <span class="sh_keyword">function</span><span class="sh_symbol">=</span><span class="sh_string">'0x0'</span><span class="sh_symbol">/&gt;</span></li><li>    <span class="sh_symbol">&lt;/</span>disk<span class="sh_symbol">&gt;</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@room9pc01 ~]# vim /etc/libvirt/qemu/vm1.xml
//修改前内容如下
&lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='qcow2'/&gt;
      &lt;source file='/var/lib/libvirt/images/vm1.qcow2'/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/&gt;
    &lt;/disk&gt;
</pre></div></div>
      <p>不推荐直接使用vim修改配置文件，推荐使用virsh edit修改配置文件，效果如下：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@room9pc01<span class="sh_symbol">]</span> virsh edit vm1           <span class="sh_comment">//vm1为虚拟机名称</span></li><li><span class="sh_symbol">&lt;</span>disk type<span class="sh_symbol">=</span><span class="sh_string">'network'</span> device<span class="sh_symbol">=</span><span class="sh_string">'disk'</span><span class="sh_symbol">&gt;</span></li><li>      <span class="sh_symbol">&lt;</span>driver name<span class="sh_symbol">=</span><span class="sh_string">'qemu'</span> type<span class="sh_symbol">=</span><span class="sh_string">'raw'</span><span class="sh_symbol">/&gt;</span></li><li>      <span class="sh_symbol">&lt;</span>auth username<span class="sh_symbol">=</span><span class="sh_string">'admin'</span><span class="sh_symbol">&gt;</span> </li><li>      <span class="sh_symbol">&lt;</span>secret type<span class="sh_symbol">=</span><span class="sh_string">'ceph'</span> uuid<span class="sh_symbol">=</span><span class="sh_string">'733f0fd1-e3d6-4c25-a69f-6681fc19802b'</span><span class="sh_symbol">/&gt;</span></li><li>      <span class="sh_symbol">&lt;/</span>auth<span class="sh_symbol">&gt;</span></li><li>      <span class="sh_symbol">&lt;</span>source protocol<span class="sh_symbol">=</span><span class="sh_string">'rbd'</span> name<span class="sh_symbol">=</span><span class="sh_string">'rbd/vm1-image'</span><span class="sh_symbol">&gt;</span>          <span class="sh_symbol">&lt;</span>host name<span class="sh_symbol">=</span><span class="sh_string">'192.168.4.11'</span> port<span class="sh_symbol">=</span><span class="sh_string">'6789'</span><span class="sh_regexp">/&gt;     &lt;/</span>source<span class="sh_symbol">&gt;</span></li><li>    <span class="sh_symbol">&lt;</span>target dev<span class="sh_symbol">=</span><span class="sh_string">'vda'</span> bus<span class="sh_symbol">=</span><span class="sh_string">'ide'</span><span class="sh_symbol">/&gt;</span></li><li>      <span class="sh_symbol">&lt;</span>address type<span class="sh_symbol">=</span><span class="sh_string">'pci'</span> domain<span class="sh_symbol">=</span><span class="sh_string">'0x0000'</span> bus<span class="sh_symbol">=</span><span class="sh_string">'0x00'</span> slot<span class="sh_symbol">=</span><span class="sh_string">'0x07'</span> <span class="sh_keyword">function</span><span class="sh_symbol">=</span><span class="sh_string">'0x0'</span><span class="sh_symbol">/&gt;</span></li><li>    <span class="sh_symbol">&lt;/</span>disk<span class="sh_symbol">&gt;</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@room9pc01] virsh edit vm1           //vm1为虚拟机名称
&lt;disk type='network' device='disk'&gt;
      &lt;driver name='qemu' type='raw'/&gt;
      &lt;auth username='admin'&gt; 
      &lt;secret type='ceph' uuid='733f0fd1-e3d6-4c25-a69f-6681fc19802b'/&gt;
      &lt;/auth&gt;
      &lt;source protocol='rbd' name='rbd/vm1-image'&gt;          &lt;host name='192.168.4.11' port='6789'/&gt;     &lt;/source&gt;
    &lt;target dev='vda' bus='ide'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/&gt;
    &lt;/disk&gt;
</pre></div></div>
      <a name="case2">
      </a>
      <h2>2 案例2：Ceph文件系统</h2>
      <h3>2.1 问题</h3>
      <p>延续前面的实验，实现Ceph文件系统的功能。具体实现有以下功能：</p>
      <ul class="list">
        <li>部署MDSs节点
</li>
        <li>创建Ceph文件系统
</li>
        <li>客户端挂载文件系统
</li>
      </ul>
      <h3>2.2 方案</h3>
      <p>添加一台虚拟机，部署MDS节点。</p>
      <p>主机的主机名及对应的IP地址如表-1所示。</p>
      <div class="table">
        <p>表－1 主机名称及对应IP地址表</p>
        <img src="./CASE_files/table001.png">
      </div>
      <h3>2.3 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p>1）添加一台新的虚拟机，要求如下：</p>
      <p>IP地址:192.168.4.14</p>
      <p>主机名:node4</p>
      <p>配置yum源（包括rhel、ceph的源）</p>
      <p>与Client主机同步时间</p>
      <p>node1允许无密码远程node4</p>
      <p>2）部署元数据服务器</p>
      <p>登陆node4，安装ceph-mds软件包</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@node4 <span class="sh_symbol">~]</span># yum <span class="sh_symbol">-</span>y install ceph<span class="sh_symbol">-</span>mds </li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@node4 ~]# yum -y install ceph-mds 
</pre></div></div>
      <p>登陆node1部署节点操作</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@node1 <span class="sh_symbol">~]</span># <span class="sh_normal">cd  </span><span class="sh_symbol">/</span><span class="sh_normal">root</span><span class="sh_symbol">/</span>ceph<span class="sh_symbol">-</span>cluster</li><li><span class="sh_comment">//该目录，是最早部署ceph集群时，创建的目录</span></li><li><span class="sh_symbol">[</span>root@node1 ceph<span class="sh_symbol">-</span>cluster<span class="sh_symbol">]</span># ceph<span class="sh_symbol">-</span>deploy mds create node4</li><li><span class="sh_comment">//给nod4拷贝配置文件，启动mds服务</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@node1 ~]# cd  /root/ceph-cluster
//该目录，是最早部署ceph集群时，创建的目录
[root@node1 ceph-cluster]# ceph-deploy mds create node4
//给nod4拷贝配置文件，启动mds服务
</pre></div></div>
      <p>同步配置文件和key</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@node1 ceph<span class="sh_symbol">-</span>cluster<span class="sh_symbol">]</span># ceph<span class="sh_symbol">-</span>deploy admin node4</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@node1 ceph-cluster]# ceph-deploy admin node4
</pre></div></div>
      <p>3）创建存储池</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@node4 <span class="sh_symbol">~]</span># ceph osd pool create cephfs_data <span class="sh_number">128</span></li><li><span class="sh_comment">//创建存储池，对应128个PG</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@node4 <span class="sh_symbol">~]</span># ceph osd pool create cephfs_metadata <span class="sh_number">128</span></li><li><span class="sh_comment">//创建存储池，对应128个PG</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@node4 ~]# ceph osd pool create cephfs_data 128
//创建存储池，对应128个PG

[root@node4 ~]# ceph osd pool create cephfs_metadata 128
//创建存储池，对应128个PG
</pre></div></div>
      <p>5）创建Ceph文件系统</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@node4 <span class="sh_symbol">~]</span># ceph mds stat                     <span class="sh_comment">//查看mds状态</span></li><li>e2<span class="sh_symbol">:,</span> <span class="sh_number">1</span> up<span class="sh_symbol">:</span>standby</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@node4 <span class="sh_symbol">~]</span># ceph fs <span class="sh_keyword">new</span> myfs1 cephfs_metadata cephfs_data</li><li><span class="sh_keyword">new</span> fs <span class="sh_keyword">with</span> metadata pool <span class="sh_number">2</span> and data pool <span class="sh_number">1</span></li><li><span class="sh_comment">//注意，现写medadata池，再写data池</span></li><li><span class="sh_comment">//默认，只能创建1个文件系统，多余的会报错</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@node4 <span class="sh_symbol">~]</span># ceph fs ls</li><li>name<span class="sh_symbol">:</span> myfs1<span class="sh_symbol">,</span> metadata pool<span class="sh_symbol">:</span> cephfs_metadata<span class="sh_symbol">,</span> data pools<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cephfs_data <span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@node4 <span class="sh_symbol">~]</span># ceph mds stat</li><li>e4<span class="sh_symbol">:</span> <span class="sh_number">1</span><span class="sh_symbol">/</span><span class="sh_number">1</span><span class="sh_symbol">/</span><span class="sh_number">1</span> up <span class="sh_cbracket">{</span><span class="sh_number">0</span><span class="sh_symbol">=</span>node4<span class="sh_symbol">=</span>up<span class="sh_symbol">:</span>creating<span class="sh_cbracket">}</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@node4 ~]# ceph mds stat                     //查看mds状态
e2:, 1 up:standby

[root@node4 ~]# ceph fs new myfs1 cephfs_metadata cephfs_data
new fs with metadata pool 2 and data pool 1
//注意，现写medadata池，再写data池
//默认，只能创建1个文件系统，多余的会报错

[root@node4 ~]# ceph fs ls
name: myfs1, metadata pool: cephfs_metadata, data pools: [cephfs_data ]

[root@node4 ~]# ceph mds stat
e4: 1/1/1 up {0=node4=up:creating}
</pre></div></div>
      <p>6）客户端挂载</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span># mount <span class="sh_symbol">-</span>t ceph <span class="sh_number">192.168.4.11</span><span class="sh_symbol">:</span><span class="sh_number">6789</span><span class="sh_symbol">:</span><span class="sh_regexp">/  /m</span><span class="sh_normal">nt</span><span class="sh_symbol">/</span><span class="sh_normal">cephfs</span><span class="sh_symbol">/</span> <span class="sh_symbol">\</span></li><li><span class="sh_symbol">-</span>o name<span class="sh_symbol">=</span>admin<span class="sh_symbol">,</span>secret<span class="sh_symbol">=</span>AQBTsdRapUxBKRAANXtteNUyoEmQHveb75bISg<span class="sh_symbol">==</span></li><li><span class="sh_comment">//注意:文件系统类型为ceph</span></li><li><span class="sh_comment">//192.168.4.11为MON节点的IP（不是MDS节点）</span></li><li><span class="sh_comment">//admin是用户名,secret是密钥</span></li><li><span class="sh_comment">//密钥可以在/etc/ceph/ceph.client.admin.keyring中找到</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@client ~]# mount -t ceph 192.168.4.11:6789:/  /mnt/cephfs/ \
-o name=admin,secret=AQBTsdRapUxBKRAANXtteNUyoEmQHveb75bISg==
//注意:文件系统类型为ceph
//192.168.4.11为MON节点的IP（不是MDS节点）
//admin是用户名,secret是密钥
//密钥可以在/etc/ceph/ceph.client.admin.keyring中找到
</pre></div></div>
      <a name="case3">
      </a>
      <h2>3 案例3：创建对象存储服务器</h2>
      <h3>3.1 问题</h3>
      <p>延续前面的实验，实现Ceph对象存储的功能。具体实现有以下功能：</p>
      <ul class="list">
        <li>安装部署Rados Gateway
</li>
        <li>启动RGW服务
</li>
        <li>设置RGW的前端服务与端口
</li>
        <li>客户端测试
</li>
      </ul>
      <h3>3.2 步骤</h3>
      <p class="number">步骤一：部署对象存储服务器</p>
      <p>1）准备实验环境，要求如下：</p>
      <p>IP地址:192.168.4.15</p>
      <p>主机名:node5</p>
      <p>配置yum源（包括rhel、ceph的源）</p>
      <p>与Client主机同步时间</p>
      <p>node1允许无密码远程node5</p>
      <p>修改node1的/etc/hosts，并同步到所有node主机</p>
      <p>2）部署RGW软件包</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@node1 <span class="sh_symbol">~]</span># ceph<span class="sh_symbol">-</span>deploy install <span class="sh_symbol">--</span>rgw node5</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@node1 ~]# ceph-deploy install --rgw node5
</pre></div></div>
      <p>同步配置文件与密钥到node5</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@node1 <span class="sh_symbol">~]</span># <span class="sh_normal">cd </span><span class="sh_symbol">/</span><span class="sh_normal">root</span><span class="sh_symbol">/</span>ceph<span class="sh_symbol">-</span>cluster</li><li><span class="sh_symbol">[</span>root@node1 <span class="sh_symbol">~]</span># ceph<span class="sh_symbol">-</span>deploy admin node5</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@node1 ~]# cd /root/ceph-cluster
[root@node1 ~]# ceph-deploy admin node5
</pre></div></div>
      <p>3）新建网关实例</p>
      <p>启动一个rgw服务</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@node1 <span class="sh_symbol">~]</span># ceph<span class="sh_symbol">-</span>deploy rgw create node5</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@node1 ~]# ceph-deploy rgw create node5
</pre></div></div>
      <p>登陆node5验证服务是否启动</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@node5 <span class="sh_symbol">~]</span># ps aux <span class="sh_symbol">|</span>grep radosgw</li><li>ceph      <span class="sh_number">4109</span>  <span class="sh_number">0.2</span>  <span class="sh_number">1.4</span> <span class="sh_number">2289196</span> <span class="sh_number">14972</span> <span class="sh_symbol">?</span>       Ssl  <span class="sh_number">22</span><span class="sh_symbol">:</span><span class="sh_number">53</span>   <span class="sh_number">0</span><span class="sh_symbol">:</span><span class="sh_number">00</span><span class="sh_normal"> </span><span class="sh_symbol">/</span><span class="sh_normal">usr</span><span class="sh_symbol">/</span><span class="sh_normal">bin</span><span class="sh_symbol">/</span>radosgw <span class="sh_symbol">-</span>f <span class="sh_symbol">--</span>cluster ceph <span class="sh_symbol">--</span>name client<span class="sh_symbol">.</span>rgw<span class="sh_symbol">.</span>node4 <span class="sh_symbol">--</span>setuser ceph <span class="sh_symbol">--</span>setgroup ceph</li><li><span class="sh_symbol">[</span>root@node5 <span class="sh_symbol">~]</span># systemctl  status ceph<span class="sh_symbol">-</span>radosgw@<span class="sh_symbol">\*</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@node5 ~]# ps aux |grep radosgw
ceph      4109  0.2  1.4 2289196 14972 ?       Ssl  22:53   0:00 /usr/bin/radosgw -f --cluster ceph --name client.rgw.node4 --setuser ceph --setgroup ceph
[root@node5 ~]# systemctl  status ceph-radosgw@\*
</pre></div></div>
      <p>4）修改服务端口</p>
      <p>登陆node5，RGW默认服务端口为7480，修改为8000或80更方便客户端记忆和使用</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@node5 <span class="sh_symbol">~]</span>#  <span class="sh_normal">vim  </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span><span class="sh_normal">ceph</span><span class="sh_symbol">/</span>ceph<span class="sh_symbol">.</span>conf</li><li><span class="sh_symbol">[</span>client<span class="sh_symbol">.</span>rgw<span class="sh_symbol">.</span>node5<span class="sh_symbol">]</span></li><li>host <span class="sh_symbol">=</span> node5</li><li>rgw_frontends <span class="sh_symbol">=</span> <span class="sh_string">"civetweb port=8000"</span></li><li><span class="sh_comment">//node5为主机名</span></li><li><span class="sh_comment">//civetweb是RGW内置的一个web服务</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@node5 ~]#  vim  /etc/ceph/ceph.conf
[client.rgw.node5]
host = node5
rgw_frontends = "civetweb port=8000"
//node5为主机名
//civetweb是RGW内置的一个web服务
</pre></div></div>
      <p class="number">步骤二：客户端测试</p>
      <p>1）curl测试</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span># curl  <span class="sh_number">192.168.4.15</span><span class="sh_symbol">:</span><span class="sh_number">8000</span></li><li><span class="sh_symbol">&lt;?</span>xml version<span class="sh_symbol">=</span><span class="sh_string">"1.0"</span> encoding<span class="sh_symbol">=</span><span class="sh_string">"UTF-8"</span><span class="sh_symbol">?&gt;&lt;</span>ListAllMyBucketsResult xmlns<span class="sh_symbol">=</span><span class="sh_string">"http://s3.amazonaws.com/doc/2006-03-01/"</span><span class="sh_symbol">&gt;&lt;</span>Owner<span class="sh_symbol">&gt;&lt;</span>ID<span class="sh_symbol">&gt;</span>anonymous<span class="sh_symbol">&lt;</span><span class="sh_regexp">/ID&gt;&lt;DisplayName&gt;&lt;/</span>DisplayName<span class="sh_symbol">&gt;&lt;</span><span class="sh_regexp">/Owner&gt;&lt;Buckets&gt;&lt;/</span>Buckets<span class="sh_symbol">&gt;&lt;/</span>ListAllMyBucketsResult<span class="sh_symbol">&gt;</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@client ~]# curl  192.168.4.15:8000
&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;ListAllMyBucketsResult xmlns="http://s3.amazonaws.com/doc/2006-03-01/"&gt;&lt;Owner&gt;&lt;ID&gt;anonymous&lt;/ID&gt;&lt;DisplayName&gt;&lt;/DisplayName&gt;&lt;/Owner&gt;&lt;Buckets&gt;&lt;/Buckets&gt;&lt;/ListAllMyBucketsResult&gt;
</pre></div></div>
      <p>2）使用第三方软件访问</p>
      <p>登陆node5（RGW）创建账户</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@node5 <span class="sh_symbol">~]</span>#  radosgw<span class="sh_symbol">-</span>admin user create <span class="sh_symbol">\</span></li><li><span class="sh_symbol">--</span>uid<span class="sh_symbol">=</span><span class="sh_string">"testuser"</span> <span class="sh_symbol">--</span>display<span class="sh_symbol">-</span>name<span class="sh_symbol">=</span><span class="sh_string">"First User"</span></li><li>… …</li><li><span class="sh_string">"keys"</span><span class="sh_symbol">:</span> <span class="sh_symbol">[</span></li><li>        <span class="sh_cbracket">{</span></li><li>            <span class="sh_string">"user"</span><span class="sh_symbol">:</span> <span class="sh_string">"testuser"</span><span class="sh_symbol">,</span></li><li>            <span class="sh_string">"access_key"</span><span class="sh_symbol">:</span> <span class="sh_string">"5E42OEGB1M95Y49IBG7B"</span><span class="sh_symbol">,</span></li><li>            <span class="sh_string">"secret_key"</span><span class="sh_symbol">:</span> <span class="sh_string">"i8YtM8cs7QDCK3rTRopb0TTPBFJVXdEryRbeLGK6"</span></li><li>        <span class="sh_cbracket">}</span></li><li>    <span class="sh_symbol">],</span></li><li><span class="sh_symbol">...</span> <span class="sh_symbol">...</span></li><li>#</li><li><span class="sh_symbol">[</span>root@node5 <span class="sh_symbol">~]</span># radosgw<span class="sh_symbol">-</span>admin user info <span class="sh_symbol">--</span>uid<span class="sh_symbol">=</span>testuser</li><li><span class="sh_comment">//testuser为用户，key是账户访问密钥</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@node5 ~]#  radosgw-admin user create \
--uid="testuser" --display-name="First User"
… …
"keys": [
        {
            "user": "testuser",
            "access_key": "5E42OEGB1M95Y49IBG7B",
            "secret_key": "i8YtM8cs7QDCK3rTRopb0TTPBFJVXdEryRbeLGK6"
        }
    ],
... ...
#
[root@node5 ~]# radosgw-admin user info --uid=testuser
//testuser为用户，key是账户访问密钥
</pre></div></div>
      <p>3）客户端安装软件</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span>#  yum install s3cmd<span class="sh_number">-2.0.1-1</span><span class="sh_symbol">.</span>el7<span class="sh_symbol">.</span>noarch<span class="sh_symbol">.</span>rpm</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@client ~]#  yum install s3cmd-2.0.1-1.el7.noarch.rpm
</pre></div></div>
      <p>修改软件配置（注意，除了下面设置的内容，其他提示都默认回车）</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span>#  s3cmd <span class="sh_symbol">--</span>configure</li><li>Access Key<span class="sh_symbol">:</span> 5E42OEGB1M95Y49IBG7BSecret Key<span class="sh_symbol">:</span> i8YtM8cs7QDCK3rTRopb0TTPBFJVXdEryRbeLGK6</li><li>S3 Endpoint <span class="sh_symbol">[</span>s3<span class="sh_symbol">.</span>amazonaws<span class="sh_symbol">.</span>com<span class="sh_symbol">]:</span> <span class="sh_number">192.168.4.15</span><span class="sh_symbol">:</span><span class="sh_number">8000</span></li><li><span class="sh_symbol">[%(</span>bucket<span class="sh_symbol">)</span>s<span class="sh_symbol">.</span>s3<span class="sh_symbol">.</span>amazonaws<span class="sh_symbol">.</span>com<span class="sh_symbol">]:</span> <span class="sh_symbol">%(</span>bucket<span class="sh_symbol">)</span>s<span class="sh_number">.192.168.4.15</span><span class="sh_symbol">:</span><span class="sh_number">8000</span></li><li>Use HTTPS protocol <span class="sh_symbol">[</span>Yes<span class="sh_symbol">]:</span> No</li><li>Test access <span class="sh_keyword">with</span> supplied credentials<span class="sh_symbol">?</span> <span class="sh_symbol">[</span><span class="sh_normal">Y</span><span class="sh_symbol">/</span>n<span class="sh_symbol">]</span> n</li><li>Save settings<span class="sh_symbol">?</span> <span class="sh_symbol">[</span><span class="sh_normal">y</span><span class="sh_symbol">/</span>N<span class="sh_symbol">]</span> y</li><li><span class="sh_comment">//注意，其他提示都默认回车</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@client ~]#  s3cmd --configure
Access Key: 5E42OEGB1M95Y49IBG7BSecret Key: i8YtM8cs7QDCK3rTRopb0TTPBFJVXdEryRbeLGK6
S3 Endpoint [s3.amazonaws.com]: 192.168.4.15:8000
[%(bucket)s.s3.amazonaws.com]: %(bucket)s.192.168.4.15:8000
Use HTTPS protocol [Yes]: No
Test access with supplied credentials? [Y/n] n
Save settings? [y/N] y
//注意，其他提示都默认回车
</pre></div></div>
      <p>4）创建存储数据的bucket（类似于存储数据的目录）</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span># s3cmd ls</li><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span># s3cmd mb s3<span class="sh_symbol">:</span><span class="sh_comment">//my_bucket</span></li><li>Bucket <span class="sh_string">'s3://my_bucket/'</span> created</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span># s3cmd ls</li><li><span class="sh_number">2018-05-09</span> <span class="sh_number">08</span><span class="sh_symbol">:</span><span class="sh_number">14</span> s3<span class="sh_symbol">:</span><span class="sh_comment">//my_bucket</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span># s3cmd <span class="sh_normal">put </span><span class="sh_symbol">/</span><span class="sh_keyword">var</span><span class="sh_regexp">/log/m</span>essages s3<span class="sh_symbol">:</span><span class="sh_comment">//my_bucket/log/</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span># s3cmd ls</li><li><span class="sh_number">2018-05-09</span> <span class="sh_number">08</span><span class="sh_symbol">:</span><span class="sh_number">14</span> s3<span class="sh_symbol">:</span><span class="sh_comment">//my_bucket</span></li><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span># s3cmd ls s3<span class="sh_symbol">:</span><span class="sh_comment">//my_bucket</span></li><li>DIR s3<span class="sh_symbol">:</span><span class="sh_comment">//my_bucket/log/</span></li><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span># s3cmd ls s3<span class="sh_symbol">:</span><span class="sh_comment">//my_bucket/log/</span></li><li><span class="sh_number">2018-05-09</span> <span class="sh_number">08</span><span class="sh_symbol">:</span><span class="sh_number">19</span> <span class="sh_number">309034</span> s3<span class="sh_symbol">:</span><span class="sh_comment">//my_bucket/log/messages </span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@client ~]# s3cmd ls
[root@client ~]# s3cmd mb s3://my_bucket
Bucket 's3://my_bucket/' created

[root@client ~]# s3cmd ls
2018-05-09 08:14 s3://my_bucket

[root@client ~]# s3cmd put /var/log/messages s3://my_bucket/log/

[root@client ~]# s3cmd ls
2018-05-09 08:14 s3://my_bucket
[root@client ~]# s3cmd ls s3://my_bucket
DIR s3://my_bucket/log/
[root@client ~]# s3cmd ls s3://my_bucket/log/
2018-05-09 08:19 309034 s3://my_bucket/log/messages 
</pre></div></div>
      <p>测试下载功能</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span># s3cmd get s3<span class="sh_symbol">:</span><span class="sh_comment">//my_bucket/log/messages /tmp/</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@client ~]# s3cmd get s3://my_bucket/log/messages /tmp/
</pre></div></div>
      <p>测试删除功能</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/CLUSTER/DAY05/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span># s3cmd del s3<span class="sh_symbol">:</span><span class="sh_comment">//my_bucket/log/messages</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@client ~]# s3cmd del s3://my_bucket/log/messages
</pre></div></div>
    </div>
  
</body></html>