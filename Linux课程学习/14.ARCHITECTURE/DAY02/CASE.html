
<!-- saved from url=(0083)http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>CASE</title>
    
    <script type="text/javascript" src="./CASE_files/jquery.min.js">
    </script>
    <script type="text/javascript" src="./CASE_files/jquery.snippet.js">
    </script>
    <script type="text/javascript" src="./CASE_files/main.js">
    </script>
    <link type="text/css" href="./CASE_files/index.css" rel="Stylesheet">
    <link type="text/css" href="./CASE_files/jquery.snippet.css" rel="Stylesheet">
  </head>
  <body>
    <div class="source_style_case">
      <a name="page_top_case" id="top_anchor">
      </a><a id="link_top" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#page_top_case">Top</a>
      <h1>NSD ARCHITECTURE DAY02</h1>
      <ol class="index">
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#case1">练习1：playbook练习</a>
        </li>
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#case2">案例2：变量练习</a>
        </li>
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#case3">案例3：handlers练习</a>
        </li>
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#case4">案例4：编写playbook</a>
        </li>
      </ol>
      <a name="case1">
      </a>
      <h2>1 练习1：playbook练习</h2>
      <h3>1.1 问题</h3>
      <p>本案例要求：</p>
      <ul class="list">
        <li>安装Apache并修改监听端口为8080
</li>
        <li>修改ServerName配置，执行apachectl -t命令不报错
</li>
        <li>设置默认主页hello world
</li>
        <li>启动服务并设开机自启
</li>
      </ul>
      <h3>1.2 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一：playbook的ping脚本检测</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim ping<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> all</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  tasks<span class="sh_symbol">:</span></li><li>     <span class="sh_symbol">-</span> ping<span class="sh_symbol">:</span></li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook ping<span class="sh_symbol">.</span>yml  <span class="sh_comment">//输出结果</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>all<span class="sh_symbol">]</span> <span class="sh_symbol">*******************************************************************</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]</span> <span class="sh_symbol">*******************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web1<span class="sh_symbol">]</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>db1<span class="sh_symbol">]</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>db2<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>ping<span class="sh_symbol">]</span> <span class="sh_symbol">******************************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>db1<span class="sh_symbol">]</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web1<span class="sh_symbol">]</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>db2<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY RECAP <span class="sh_symbol">*******************************************************************</span></li><li>cache                      <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">2</span>    changed<span class="sh_symbol">=</span><span class="sh_number">0</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>   </li><li>db1                        <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">2</span>    changed<span class="sh_symbol">=</span><span class="sh_number">0</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>   </li><li>db2                        <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">2</span>    changed<span class="sh_symbol">=</span><span class="sh_number">0</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>   </li><li>web1                       <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">2</span>    changed<span class="sh_symbol">=</span><span class="sh_number">0</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>   </li><li>web2                       <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">2</span>    changed<span class="sh_symbol">=</span><span class="sh_number">0</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# vim ping.yml
---
- hosts: all
  remote_user: root
  tasks:
     - ping:
[root@ansible ansible]# ansible-playbook ping.yml  //输出结果

PLAY [all] *******************************************************************

TASK [Gathering Facts] *******************************************************
ok: [web1]
ok: [web2]
ok: [cache]
ok: [db1]
ok: [db2]

TASK [ping] ******************************************************************
ok: [db1]
ok: [web2]
ok: [cache]
ok: [web1]
ok: [db2]

PLAY RECAP *******************************************************************
cache                      : ok=2    changed=0    unreachable=0    failed=0   
db1                        : ok=2    changed=0    unreachable=0    failed=0   
db2                        : ok=2    changed=0    unreachable=0    failed=0   
web1                       : ok=2    changed=0    unreachable=0    failed=0   
web2                       : ok=2    changed=0    unreachable=0    failed=0
</pre></div></div>
      <p>注意：如果检测的时候出错，会在当前的目录生成一个新的文件（以.retry结尾），可以去这个文件里面看是哪个主机的错</p>
      <p class="number">步骤二：用playbook安装Apache,修改端口，配置ServerName，修改主页，设置开机自启</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim http<span class="sh_symbol">.</span>yml</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> cache</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  tasks<span class="sh_symbol">:</span></li><li>    <span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> install one specific version of Apache</li><li>      yum<span class="sh_symbol">:</span></li><li>        name<span class="sh_symbol">:</span> httpd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//安装Apache</span></li><li>        state<span class="sh_symbol">:</span> installed</li><li>    <span class="sh_symbol">-</span> lineinfile<span class="sh_symbol">:</span></li><li>        path<span class="sh_symbol">:</span> <span class="sh_regexp">/etc/</span><span class="sh_normal">httpd</span><span class="sh_symbol">/</span><span class="sh_normal">conf</span><span class="sh_symbol">/</span>httpd<span class="sh_symbol">.</span>conf</li><li>        regexp<span class="sh_symbol">:</span> <span class="sh_string">'^Listen '</span></li><li>        line<span class="sh_symbol">:</span> <span class="sh_string">'Listen 8080'</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//修改端口为8080</span></li><li>    <span class="sh_symbol">-</span> replace<span class="sh_symbol">:</span></li><li>        path<span class="sh_symbol">:</span> <span class="sh_regexp">/etc/</span><span class="sh_normal">httpd</span><span class="sh_symbol">/</span><span class="sh_normal">conf</span><span class="sh_symbol">/</span>httpd<span class="sh_symbol">.</span>conf</li><li>        regexp<span class="sh_symbol">:</span> <span class="sh_string">'^#(ServerName).*'</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//配置ServerName</span></li><li>        replace<span class="sh_symbol">:</span> <span class="sh_string">'</span><span class="sh_specialchar">\1</span><span class="sh_string"> localhost'</span></li><li>    <span class="sh_symbol">-</span> service<span class="sh_symbol">:</span></li><li>        name<span class="sh_symbol">:</span> httpd</li><li>        enabled<span class="sh_symbol">:</span> yes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//开机自启</span></li><li>        state<span class="sh_symbol">:</span> restarted</li><li>    <span class="sh_symbol">-</span> copy<span class="sh_symbol">:</span></li><li>        src<span class="sh_symbol">:</span> <span class="sh_regexp">/root/i</span>ndex<span class="sh_symbol">.</span>html&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//修改主页，可以自己写个页面</span></li><li>        dest<span class="sh_symbol">:</span> <span class="sh_regexp">/var/</span><span class="sh_normal">www</span><span class="sh_symbol">/</span><span class="sh_normal">html</span><span class="sh_symbol">/</span>index<span class="sh_symbol">.</span>html</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># curl <span class="sh_number">192.168.1.56</span><span class="sh_symbol">:</span><span class="sh_number">8080</span></li><li>hello world</li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ssh cache</li><li>Last login<span class="sh_symbol">:</span> Fri Sep  <span class="sh_number">7</span> <span class="sh_number">09</span><span class="sh_symbol">:</span><span class="sh_number">32</span><span class="sh_symbol">:</span><span class="sh_number">05</span> <span class="sh_number">2018</span> from <span class="sh_number">192.168.1.51</span></li><li><span class="sh_symbol">[</span>root@cache <span class="sh_symbol">~]</span># apachectl <span class="sh_symbol">-</span>t</li><li>Syntax OK</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# vim http.yml

---
- hosts: cache
  remote_user: root
  tasks:
    - name: install one specific version of Apache
      yum:
        name: httpd		//安装Apache
        state: installed
    - lineinfile:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^Listen '
        line: 'Listen 8080'		//修改端口为8080
    - replace:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^#(ServerName).*'		//配置ServerName
        replace: '\1 localhost'
    - service:
        name: httpd
        enabled: yes		//开机自启
        state: restarted
    - copy:
        src: /root/index.html		//修改主页，可以自己写个页面
        dest: /var/www/html/index.html

[root@ansible ansible]# curl 192.168.1.56:8080
hello world
[root@ansible ansible]# ssh cache
Last login: Fri Sep  7 09:32:05 2018 from 192.168.1.51
[root@cache ~]# apachectl -t
Syntax OK
</pre></div></div>
      <a name="case2">
      </a>
      <h2>2 案例2：变量练习</h2>
      <h3>2.1 问题</h3>
      <p>本案例要求熟悉playbook进阶：</p>
      <ul class="list">
        <li>练习使用user模块添加用户
</li>
        <li>练习使用变量简化task，让play通用性更强
</li>
        <li>练习使用过滤器
</li>
      </ul>
      <h3>2.2 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一：使用user模块添加用户，并修改密码</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim user<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> cache</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  vars<span class="sh_symbol">:</span></li><li>    username<span class="sh_symbol">:</span> xiaoming</li><li>  tasks<span class="sh_symbol">:</span></li><li>    <span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> create user <span class="sh_string">"{{username}}"</span></li><li>      user<span class="sh_symbol">:</span> group<span class="sh_symbol">=</span>wheel uid<span class="sh_symbol">=</span><span class="sh_number">1000</span> name<span class="sh_symbol">=</span><span class="sh_cbracket">{{</span>username<span class="sh_cbracket">}}</span></li><li>    <span class="sh_symbol">-</span> shell<span class="sh_symbol">:</span> echo <span class="sh_number">123456</span> <span class="sh_symbol">|</span> passwd <span class="sh_symbol">--</span>stdin xiaoming</li><li>    <span class="sh_symbol">-</span> shell<span class="sh_symbol">:</span> chage <span class="sh_symbol">-</span>d <span class="sh_number">0</span> <span class="sh_cbracket">{{</span>username<span class="sh_cbracket">}}</span></li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook user<span class="sh_symbol">.</span>yml   <span class="sh_comment">//执行结果</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span> <span class="sh_symbol">******************************************************************</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]</span> <span class="sh_symbol">********************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>create user <span class="sh_string">" xiaoming "</span><span class="sh_symbol">]</span> <span class="sh_symbol">***********************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>command<span class="sh_symbol">]</span> <span class="sh_symbol">****************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>command<span class="sh_symbol">]</span> <span class="sh_symbol">****************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY RECAP <span class="sh_symbol">********************************************************************</span></li><li>cache                      <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">4</span>    changed<span class="sh_symbol">=</span><span class="sh_number">3</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# vim user.yml
---
- hosts: cache
  remote_user: root
  vars:
    username: xiaoming
  tasks:
    - name: create user "{{username}}"
      user: group=wheel uid=1000 name={{username}}
    - shell: echo 123456 | passwd --stdin xiaoming
    - shell: chage -d 0 {{username}}
[root@ansible ansible]# ansible-playbook user.yml   //执行结果

PLAY [cache] ******************************************************************

TASK [Gathering Facts] ********************************************************
ok: [cache]

TASK [create user " xiaoming "] ***********************************************
changed: [cache]

TASK [command] ****************************************************************
changed: [cache]

TASK [command] ****************************************************************
changed: [cache]

PLAY RECAP ********************************************************************
cache                      : ok=4    changed=3    unreachable=0    failed=0


</pre></div></div>
      <p class="number">步骤二：变量过滤器，创建一个用户，设置密码</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim user1<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> cache</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  tasks<span class="sh_symbol">:</span></li><li>   <span class="sh_symbol">-</span> user<span class="sh_symbol">:</span></li><li>       name<span class="sh_symbol">:</span> lisi</li><li>       group<span class="sh_symbol">:</span> root</li><li>       password<span class="sh_symbol">:</span> <span class="sh_string">"{{'123456' | password_hash('sha512')}}"</span></li><li>   <span class="sh_symbol">-</span> shell<span class="sh_symbol">:</span> chage <span class="sh_symbol">-</span>d <span class="sh_number">0</span> lisi</li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook user1<span class="sh_symbol">.</span>yml </li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span> <span class="sh_symbol">******************************************************************</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]</span> <span class="sh_symbol">********************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>user<span class="sh_symbol">]</span> <span class="sh_symbol">*******************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span> </li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>command<span class="sh_symbol">]</span> <span class="sh_symbol">****************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY RECAP <span class="sh_symbol">********************************************************************</span></li><li>cache                      <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">3</span>    changed<span class="sh_symbol">=</span><span class="sh_number">2</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>   </li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# vim user1.yml
---
- hosts: cache
  remote_user: root
  tasks:
   - user:
       name: lisi
       group: root
       password: "{{'123456' | password_hash('sha512')}}"
   - shell: chage -d 0 lisi
[root@ansible ansible]# ansible-playbook user1.yml 

PLAY [cache] ******************************************************************

TASK [Gathering Facts] ********************************************************
ok: [cache]

TASK [user] *******************************************************************
changed: [cache] 

TASK [command] ****************************************************************
changed: [cache]

PLAY RECAP ********************************************************************
cache                      : ok=3    changed=2    unreachable=0    failed=0   

</pre></div></div>
      <p class="number">步骤三：定义一个变量创建用户</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim user2<span class="sh_symbol">.</span>yml</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> cache</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  vars<span class="sh_symbol">:</span></li><li>    user<span class="sh_symbol">:</span> zhangs</li><li>  tasks<span class="sh_symbol">:</span></li><li>    <span class="sh_symbol">-</span> user<span class="sh_symbol">:</span></li><li>        name<span class="sh_symbol">:</span> <span class="sh_string">"{{user}}"</span></li><li>        group<span class="sh_symbol">:</span> root</li><li>        password<span class="sh_symbol">:</span> <span class="sh_string">"{{'123456' | password_hash('sha512')}}"</span></li><li>    <span class="sh_symbol">-</span> shell<span class="sh_symbol">:</span> chage <span class="sh_symbol">-</span>d <span class="sh_number">0</span> <span class="sh_string">"{{user}}"</span></li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook user2<span class="sh_symbol">.</span>yml</li><li>PLAY <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span> <span class="sh_symbol">******************************************************************</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]</span> <span class="sh_symbol">********************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>user<span class="sh_symbol">]</span> <span class="sh_symbol">*******************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>command<span class="sh_symbol">]</span> <span class="sh_symbol">****************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY RECAP <span class="sh_symbol">********************************************************************</span></li><li>cache                      <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">3</span>    changed<span class="sh_symbol">=</span><span class="sh_number">2</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>   </li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# vim user2.yml

---
- hosts: cache
  remote_user: root
  vars:
    user: zhangs
  tasks:
    - user:
        name: "{{user}}"
        group: root
        password: "{{'123456' | password_hash('sha512')}}"
    - shell: chage -d 0 "{{user}}"
[root@ansible ansible]# ansible-playbook user2.yml
PLAY [cache] ******************************************************************

TASK [Gathering Facts] ********************************************************
ok: [cache]

TASK [user] *******************************************************************
changed: [cache]

TASK [command] ****************************************************************
changed: [cache]

PLAY RECAP ********************************************************************
cache                      : ok=3    changed=2    unreachable=0    failed=0   

</pre></div></div>
      <a name="case3">
      </a>
      <h2>3 案例3：handlers练习</h2>
      <h3>3.1 问题</h3>
      <p>本案例要求：</p>
      <ul class="list">
        <li>安装Apache软件
</li>
        <li>配置文件，重新载入配置文件让服务生效
</li>
        <li>使用handlers来实现
</li>
      </ul>
      <h3>3.2 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一：error</p>
      <p>playbook从上往下顺序执行，若报错，后面的命令不会在执行，若想解决有两种方法：</p>
      <p>1）当返回值为假时，显示true： - shell: setenforce 0 || true</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim user5<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> cache</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  vars<span class="sh_symbol">:</span></li><li>    user<span class="sh_symbol">:</span> bb</li><li>  tasks<span class="sh_symbol">:</span></li><li>   <span class="sh_symbol">-</span> shell<span class="sh_symbol">:</span> setenforce <span class="sh_number">0</span> <span class="sh_symbol">||</span> <span class="sh_keyword">true</span></li><li>   <span class="sh_symbol">-</span> user<span class="sh_symbol">:</span></li><li>       name<span class="sh_symbol">:</span> <span class="sh_string">"{{user}}"</span></li><li>       group<span class="sh_symbol">:</span> root</li><li>       password<span class="sh_symbol">:</span> <span class="sh_string">"{{'123456' | password_hash('sha512')}}"</span></li><li>   <span class="sh_symbol">-</span> shell<span class="sh_symbol">:</span> chage <span class="sh_symbol">-</span>d <span class="sh_number">0</span> <span class="sh_string">"{{user}}"</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook user5<span class="sh_symbol">.</span>yml </li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span> <span class="sh_symbol">******************************************************************</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]</span> <span class="sh_symbol">********************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>command<span class="sh_symbol">]</span> <span class="sh_symbol">****************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>user<span class="sh_symbol">]</span> <span class="sh_symbol">*******************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>command<span class="sh_symbol">]</span> <span class="sh_symbol">****************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY RECAP <span class="sh_symbol">********************************************************************</span></li><li>cache                      <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">4</span>    changed<span class="sh_symbol">=</span><span class="sh_number">3</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>   </li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# vim user5.yml
---
- hosts: cache
  remote_user: root
  vars:
    user: bb
  tasks:
   - shell: setenforce 0 || true
   - user:
       name: "{{user}}"
       group: root
       password: "{{'123456' | password_hash('sha512')}}"
   - shell: chage -d 0 "{{user}}"

[root@ansible ansible]# ansible-playbook user5.yml 

PLAY [cache] ******************************************************************

TASK [Gathering Facts] ********************************************************
ok: [cache]

TASK [command] ****************************************************************
changed: [cache]

TASK [user] *******************************************************************
changed: [cache]

TASK [command] ****************************************************************
changed: [cache]

PLAY RECAP ********************************************************************
cache                      : ok=4    changed=3    unreachable=0    failed=0   

</pre></div></div>
      <p>2、忽略：ignoring_errors: True(推荐使用这个，会有报错信息，告诉你错误忽略，继续执行下面的命令)</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim user6<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> cache</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  vars<span class="sh_symbol">:</span></li><li>    user<span class="sh_symbol">:</span> bb</li><li>  tasks<span class="sh_symbol">:</span></li><li>   <span class="sh_symbol">-</span> shell<span class="sh_symbol">:</span> setenforce <span class="sh_number">0</span> </li><li>     ignore_errors<span class="sh_symbol">:</span> True</li><li>   <span class="sh_symbol">-</span> user<span class="sh_symbol">:</span></li><li>       name<span class="sh_symbol">:</span> <span class="sh_string">"{{user}}"</span></li><li>       group<span class="sh_symbol">:</span> root</li><li>       password<span class="sh_symbol">:</span> <span class="sh_string">"{{'123456' | password_hash('sha512')}}"</span></li><li>   <span class="sh_symbol">-</span> shell<span class="sh_symbol">:</span> chage <span class="sh_symbol">-</span>d <span class="sh_number">0</span> <span class="sh_string">"{{user}}"</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook user6<span class="sh_symbol">.</span>yml </li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span> <span class="sh_symbol">******************************************************************</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]</span> <span class="sh_symbol">********************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>command<span class="sh_symbol">]</span> <span class="sh_symbol">****************************************************************</span></li><li>fatal<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]:</span> FAILED<span class="sh_symbol">!</span> <span class="sh_symbol">=&gt;</span> <span class="sh_cbracket">{</span><span class="sh_string">"changed"</span><span class="sh_symbol">:</span> <span class="sh_keyword">true</span><span class="sh_symbol">,</span> <span class="sh_string">"cmd"</span><span class="sh_symbol">:</span> <span class="sh_string">"setenforce 0"</span><span class="sh_symbol">,</span> <span class="sh_string">"delta"</span><span class="sh_symbol">:</span> <span class="sh_string">"0:00:00.004198"</span><span class="sh_symbol">,</span> <span class="sh_string">"end"</span><span class="sh_symbol">:</span> <span class="sh_string">"2018-09-07 11:08:14.936959"</span><span class="sh_symbol">,</span> <span class="sh_string">"msg"</span><span class="sh_symbol">:</span> <span class="sh_string">"non-zero return code"</span><span class="sh_symbol">,</span> <span class="sh_string">"rc"</span><span class="sh_symbol">:</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> <span class="sh_string">"start"</span><span class="sh_symbol">:</span> <span class="sh_string">"2018-09-07 11:08:14.932761"</span><span class="sh_symbol">,</span> <span class="sh_string">"stderr"</span><span class="sh_symbol">:</span> <span class="sh_string">"setenforce: SELinux is disabled"</span><span class="sh_symbol">,</span> <span class="sh_string">"stderr_lines"</span><span class="sh_symbol">:</span> <span class="sh_symbol">[</span><span class="sh_string">"setenforce: SELinux is disabled"</span><span class="sh_symbol">],</span> <span class="sh_string">"stdout"</span><span class="sh_symbol">:</span> <span class="sh_string">""</span><span class="sh_symbol">,</span> <span class="sh_string">"stdout_lines"</span><span class="sh_symbol">:</span> <span class="sh_symbol">[]</span><span class="sh_cbracket">}</span></li><li><span class="sh_symbol">...</span>ignoring</li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>user<span class="sh_symbol">]</span> <span class="sh_symbol">*******************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>command<span class="sh_symbol">]</span> <span class="sh_symbol">****************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY RECAP <span class="sh_symbol">********************************************************************</span></li><li>cache                      <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">4</span>    changed<span class="sh_symbol">=</span><span class="sh_number">3</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>   </li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# vim user6.yml
---
- hosts: cache
  remote_user: root
  vars:
    user: bb
  tasks:
   - shell: setenforce 0 
     ignore_errors: True
   - user:
       name: "{{user}}"
       group: root
       password: "{{'123456' | password_hash('sha512')}}"
   - shell: chage -d 0 "{{user}}"

[root@ansible ansible]# ansible-playbook user6.yml 

PLAY [cache] ******************************************************************

TASK [Gathering Facts] ********************************************************
ok: [cache]

TASK [command] ****************************************************************
fatal: [cache]: FAILED! =&gt; {"changed": true, "cmd": "setenforce 0", "delta": "0:00:00.004198", "end": "2018-09-07 11:08:14.936959", "msg": "non-zero return code", "rc": 1, "start": "2018-09-07 11:08:14.932761", "stderr": "setenforce: SELinux is disabled", "stderr_lines": ["setenforce: SELinux is disabled"], "stdout": "", "stdout_lines": []}
...ignoring

TASK [user] *******************************************************************
changed: [cache]

TASK [command] ****************************************************************
changed: [cache]

PLAY RECAP ********************************************************************
cache                      : ok=4    changed=3    unreachable=0    failed=0   
</pre></div></div>
      <p class="number">步骤二： handlers</p>
      <p>关注的资源发生变化时采取的操作</p>
      <p>1) 使用handlers来配置文件，重新载入配置文件让服务生效</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim adhttp<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> cache</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  tasks<span class="sh_symbol">:</span></li><li>    <span class="sh_symbol">-</span> copy<span class="sh_symbol">:</span></li><li>        src<span class="sh_symbol">:</span> <span class="sh_regexp">/root/</span>httpd<span class="sh_symbol">.</span>conf</li><li>        dest<span class="sh_symbol">:</span>  <span class="sh_regexp">/etc/</span><span class="sh_normal">httpd</span><span class="sh_symbol">/</span><span class="sh_normal">conf</span><span class="sh_symbol">/</span>httpd<span class="sh_symbol">.</span>conf</li><li>        owner<span class="sh_symbol">:</span> root</li><li>        group<span class="sh_symbol">:</span> root</li><li>        mode<span class="sh_symbol">:</span> <span class="sh_number">0644</span></li><li>      notify<span class="sh_symbol">:</span></li><li>        <span class="sh_symbol">-</span> restart httpd</li><li>  handlers<span class="sh_symbol">:</span></li><li>     <span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> restart httpd</li><li>       service<span class="sh_symbol">:</span> name<span class="sh_symbol">=</span>httpd state<span class="sh_symbol">=</span>restarted</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook adhttp<span class="sh_symbol">.</span>yml </li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span> <span class="sh_symbol">******************************************************************</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]</span> <span class="sh_symbol">********************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>copy<span class="sh_symbol">]</span> <span class="sh_symbol">*******************************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY RECAP <span class="sh_symbol">********************************************************************</span></li><li>cache                      <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">2</span>    changed<span class="sh_symbol">=</span><span class="sh_number">0</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>  </li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ssh cache apachectl <span class="sh_symbol">-</span>t</li><li>Syntax OK</li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># curl <span class="sh_number">192.168.1.56</span><span class="sh_symbol">:</span><span class="sh_number">8080</span></li><li>hello world</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# vim adhttp.yml
---
- hosts: cache
  remote_user: root
  tasks:
    - copy:
        src: /root/httpd.conf
        dest:  /etc/httpd/conf/httpd.conf
        owner: root
        group: root
        mode: 0644
      notify:
        - restart httpd
  handlers:
     - name: restart httpd
       service: name=httpd state=restarted

[root@ansible ansible]# ansible-playbook adhttp.yml 

PLAY [cache] ******************************************************************

TASK [Gathering Facts] ********************************************************
ok: [cache]

TASK [copy] *******************************************************************
ok: [cache]

PLAY RECAP ********************************************************************
cache                      : ok=2    changed=0    unreachable=0    failed=0  
 
[root@ansible ansible]# ssh cache apachectl -t
Syntax OK
[root@ansible ansible]# curl 192.168.1.56:8080
hello world
</pre></div></div>
      <p>2）使用脚本调用变量更改服务</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim adhttp2<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> cache</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  vars<span class="sh_symbol">:</span></li><li>    server<span class="sh_symbol">:</span> httpd</li><li>  tasks<span class="sh_symbol">:</span></li><li>    <span class="sh_symbol">-</span> copy<span class="sh_symbol">:</span></li><li>        src<span class="sh_symbol">:</span> <span class="sh_regexp">/root/</span>httpd<span class="sh_symbol">.</span>conf</li><li>        dest<span class="sh_symbol">:</span>  <span class="sh_regexp">/etc/</span><span class="sh_normal">httpd</span><span class="sh_symbol">/</span><span class="sh_normal">conf</span><span class="sh_symbol">/</span>httpd<span class="sh_symbol">.</span>conf</li><li>        owner<span class="sh_symbol">:</span> root</li><li>        group<span class="sh_symbol">:</span> root</li><li>        mode<span class="sh_symbol">:</span> <span class="sh_number">0644</span></li><li>      notify<span class="sh_symbol">:</span></li><li>        <span class="sh_symbol">-</span> restart <span class="sh_string">"{{server}}"</span></li><li>  handlers<span class="sh_symbol">:</span></li><li>     <span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> restart <span class="sh_string">"{{server}}"</span></li><li>       service<span class="sh_symbol">:</span> name<span class="sh_symbol">=</span>httpd state<span class="sh_symbol">=</span>restarted</li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook adhttp2<span class="sh_symbol">.</span>yml </li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span> <span class="sh_symbol">************************************************************************************************************</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]</span> <span class="sh_symbol">**************************************************************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>copy<span class="sh_symbol">]</span> <span class="sh_symbol">*************************************************************************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY RECAP <span class="sh_symbol">**************************************************************************************************************</span></li><li>cache                      <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">2</span>    changed<span class="sh_symbol">=</span><span class="sh_number">0</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>   </li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span>#</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# vim adhttp2.yml
---
- hosts: cache
  remote_user: root
  vars:
    server: httpd
  tasks:
    - copy:
        src: /root/httpd.conf
        dest:  /etc/httpd/conf/httpd.conf
        owner: root
        group: root
        mode: 0644
      notify:
        - restart "{{server}}"
  handlers:
     - name: restart "{{server}}"
       service: name=httpd state=restarted
[root@ansible ansible]# ansible-playbook adhttp2.yml 

PLAY [cache] ************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************
ok: [cache]

TASK [copy] *************************************************************************************************************
ok: [cache]

PLAY RECAP **************************************************************************************************************
cache                      : ok=2    changed=0    unreachable=0    failed=0   

[root@ansible ansible]#
</pre></div></div>
      <a name="case4">
      </a>
      <h2>4 案例4：编写playbook</h2>
      <h3>4.1 问题</h3>
      <p>本案例要求：</p>
      <ul class="list">
        <li>把所有监听端口是8080的Apache服务全部停止
</li>
      </ul>
      <h3>4.2 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一：把监听端口是8080的Apache服务全部停止</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim ad<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> cache</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  tasks<span class="sh_symbol">:</span></li><li>    <span class="sh_symbol">-</span> shell<span class="sh_symbol">:</span> netstat <span class="sh_symbol">-</span>atunlp  <span class="sh_symbol">|</span> awk  <span class="sh_string">'{print $4}'</span><span class="sh_symbol">|</span> awk <span class="sh_string">'-F:'</span> <span class="sh_string">'{print $2}'</span></li><li>      register<span class="sh_symbol">:</span> result</li><li>    <span class="sh_symbol">-</span> service<span class="sh_symbol">:</span></li><li>        name<span class="sh_symbol">:</span> httpd</li><li>        state<span class="sh_symbol">:</span> stopped</li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook ad<span class="sh_symbol">.</span>yml </li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span> <span class="sh_symbol">************************************************************************************************************</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]</span> <span class="sh_symbol">**************************************************************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>command<span class="sh_symbol">]</span> <span class="sh_symbol">**********************************************************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>service<span class="sh_symbol">]</span> <span class="sh_symbol">**********************************************************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY RECAP <span class="sh_symbol">**************************************************************************************************************</span></li><li>cache                      <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">3</span>    changed<span class="sh_symbol">=</span><span class="sh_number">2</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>   </li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# vim ad.yml
---
- hosts: cache
  remote_user: root
  tasks:
    - shell: netstat -atunlp  | awk  '{print $4}'| awk '-F:' '{print $2}'
      register: result
    - service:
        name: httpd
        state: stopped
[root@ansible ansible]# ansible-playbook ad.yml 

PLAY [cache] ************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************
ok: [cache]

TASK [command] **********************************************************************************************************
changed: [cache]

TASK [service] **********************************************************************************************************
changed: [cache]

PLAY RECAP **************************************************************************************************************
cache                      : ok=3    changed=2    unreachable=0    failed=0   
</pre></div></div>
      <p class="number">步骤二：when条件判断</p>
      <p>1）当系统负载超过0.7时，则关掉httpd</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim when<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> cache</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  tasks<span class="sh_symbol">:</span></li><li>    <span class="sh_symbol">-</span> shell<span class="sh_symbol">:</span> uptime <span class="sh_symbol">|</span> awk <span class="sh_string">'{printf("%.2f",$(NF-2))}'</span></li><li>      register<span class="sh_symbol">:</span> result</li><li>    <span class="sh_symbol">-</span> service<span class="sh_symbol">:</span></li><li>        name<span class="sh_symbol">:</span> httpd</li><li>        state<span class="sh_symbol">:</span> stopped</li><li>      when<span class="sh_symbol">:</span> result<span class="sh_symbol">.</span>stdout<span class="sh_symbol">|</span>float <span class="sh_symbol">&gt;</span> <span class="sh_number">0.7</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook when<span class="sh_symbol">.</span>yml </li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span> <span class="sh_symbol">************************************************************************************************************</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]</span> <span class="sh_symbol">**************************************************************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>command<span class="sh_symbol">]</span> <span class="sh_symbol">**********************************************************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>service<span class="sh_symbol">]</span> <span class="sh_symbol">**********************************************************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY RECAP <span class="sh_symbol">**************************************************************************************************************</span></li><li>cache                      <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">3</span>    changed<span class="sh_symbol">=</span><span class="sh_number">2</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>   </li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# vim when.yml
---
- hosts: cache
  remote_user: root
  tasks:
    - shell: uptime | awk '{printf("%.2f",$(NF-2))}'
      register: result
    - service:
        name: httpd
        state: stopped
      when: result.stdout|float &gt; 0.7

[root@ansible ansible]# ansible-playbook when.yml 

PLAY [cache] ************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************
ok: [cache]

TASK [command] **********************************************************************************************************
changed: [cache]

TASK [service] **********************************************************************************************************
changed: [cache]

PLAY RECAP **************************************************************************************************************
cache                      : ok=3    changed=2    unreachable=0    failed=0   

</pre></div></div>
      <p class="number">步骤三：with_items标准循环</p>
      <p>1）为不同用户定义不同组</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim add<span class="sh_symbol">.</span>yml</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> web2</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  tasks<span class="sh_symbol">:</span></li><li>    <span class="sh_symbol">-</span> user<span class="sh_symbol">:</span></li><li>        name<span class="sh_symbol">:</span> <span class="sh_string">"{{item.name}}"</span></li><li>        group<span class="sh_symbol">:</span> <span class="sh_string">"{{item.group}}"</span></li><li>        password<span class="sh_symbol">:</span> <span class="sh_string">"{{'123456'|password_hash('sha512')}}"</span></li><li>      with_items<span class="sh_symbol">:</span></li><li>        <span class="sh_symbol">-</span> <span class="sh_cbracket">{</span>name<span class="sh_symbol">:</span> <span class="sh_string">"aa"</span><span class="sh_symbol">,</span> group<span class="sh_symbol">:</span> <span class="sh_string">"users"</span><span class="sh_cbracket">}</span></li><li>        <span class="sh_symbol">-</span> <span class="sh_cbracket">{</span>name<span class="sh_symbol">:</span> <span class="sh_string">"bb"</span><span class="sh_symbol">,</span> group<span class="sh_symbol">:</span> <span class="sh_string">"mail"</span> <span class="sh_cbracket">}</span></li><li>        <span class="sh_symbol">-</span> <span class="sh_cbracket">{</span>name<span class="sh_symbol">:</span> <span class="sh_string">"cc"</span><span class="sh_symbol">,</span> group<span class="sh_symbol">:</span> <span class="sh_string">"wheel"</span><span class="sh_cbracket">}</span></li><li>        <span class="sh_symbol">-</span> <span class="sh_cbracket">{</span>name<span class="sh_symbol">:</span> <span class="sh_string">"dd"</span><span class="sh_symbol">,</span> group<span class="sh_symbol">:</span> <span class="sh_string">"root"</span> <span class="sh_cbracket">}</span></li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook add<span class="sh_symbol">.</span>yml </li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">*************************************************************************************************************</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]</span> <span class="sh_symbol">**************************************************************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>user<span class="sh_symbol">]</span> <span class="sh_symbol">*************************************************************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_symbol">(</span>item<span class="sh_symbol">=</span><span class="sh_cbracket">{</span>u<span class="sh_string">'group'</span><span class="sh_symbol">:</span> u<span class="sh_string">'users'</span><span class="sh_symbol">,</span> u<span class="sh_string">'name'</span><span class="sh_symbol">:</span> u<span class="sh_string">'aa'</span><span class="sh_cbracket">}</span><span class="sh_symbol">)</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_symbol">(</span>item<span class="sh_symbol">=</span><span class="sh_cbracket">{</span>u<span class="sh_string">'group'</span><span class="sh_symbol">:</span> u<span class="sh_string">'mail'</span><span class="sh_symbol">,</span> u<span class="sh_string">'name'</span><span class="sh_symbol">:</span> u<span class="sh_string">'bb'</span><span class="sh_cbracket">}</span><span class="sh_symbol">)</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_symbol">(</span>item<span class="sh_symbol">=</span><span class="sh_cbracket">{</span>u<span class="sh_string">'group'</span><span class="sh_symbol">:</span> u<span class="sh_string">'wheel'</span><span class="sh_symbol">,</span> u<span class="sh_string">'name'</span><span class="sh_symbol">:</span> u<span class="sh_string">'cc'</span><span class="sh_cbracket">}</span><span class="sh_symbol">)</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_symbol">(</span>item<span class="sh_symbol">=</span><span class="sh_cbracket">{</span>u<span class="sh_string">'group'</span><span class="sh_symbol">:</span> u<span class="sh_string">'root'</span><span class="sh_symbol">,</span> u<span class="sh_string">'name'</span><span class="sh_symbol">:</span> u<span class="sh_string">'dd'</span><span class="sh_cbracket">}</span><span class="sh_symbol">)</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY RECAP <span class="sh_symbol">**************************************************************************************************************</span></li><li>web2                       <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">2</span>    changed<span class="sh_symbol">=</span><span class="sh_number">1</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>   </li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# vim add.yml

---
- hosts: web2
  remote_user: root
  tasks:
    - user:
        name: "{{item.name}}"
        group: "{{item.group}}"
        password: "{{'123456'|password_hash('sha512')}}"
      with_items:
        - {name: "aa", group: "users"}
        - {name: "bb", group: "mail" }
        - {name: "cc", group: "wheel"}
        - {name: "dd", group: "root" }
[root@ansible ansible]# ansible-playbook add.yml 

PLAY [web2] *************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************
ok: [web2]

TASK [user] *************************************************************************************************************
changed: [web2] =&gt; (item={u'group': u'users', u'name': u'aa'})
changed: [web2] =&gt; (item={u'group': u'mail', u'name': u'bb'})
changed: [web2] =&gt; (item={u'group': u'wheel', u'name': u'cc'})
changed: [web2] =&gt; (item={u'group': u'root', u'name': u'dd'})

PLAY RECAP **************************************************************************************************************
web2                       : ok=2    changed=1    unreachable=0    failed=0   
</pre></div></div>
      <p>2）嵌套循环，循环添加多用户</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim add1<span class="sh_symbol">.</span>yml </li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> web2</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  vars<span class="sh_symbol">:</span></li><li>    un<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>a<span class="sh_symbol">,</span> b<span class="sh_symbol">,</span> c<span class="sh_symbol">]</span></li><li>    id<span class="sh_symbol">:</span> <span class="sh_symbol">[</span><span class="sh_number">1</span><span class="sh_symbol">,</span> <span class="sh_number">2</span><span class="sh_symbol">,</span> <span class="sh_number">3</span><span class="sh_symbol">]</span></li><li>  tasks<span class="sh_symbol">:</span></li><li>    <span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> add users</li><li>      shell<span class="sh_symbol">:</span> echo <span class="sh_cbracket">{{</span>item<span class="sh_cbracket">}}</span></li><li>      with_nested<span class="sh_symbol">:</span></li><li>        <span class="sh_symbol">-</span> <span class="sh_string">"{{un}}"</span></li><li>        <span class="sh_symbol">-</span> <span class="sh_string">"{{id}}"</span></li><li><span style="display:none;">&nbsp;</span></li><li> <span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook add1<span class="sh_symbol">.</span>yml </li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">*************************************************************************************************************</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]</span> <span class="sh_symbol">**************************************************************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>add users<span class="sh_symbol">]</span> <span class="sh_symbol">********************************************************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_symbol">(</span>item<span class="sh_symbol">=[</span>u<span class="sh_string">'a'</span><span class="sh_symbol">,</span> <span class="sh_number">1</span><span class="sh_symbol">])</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_symbol">(</span>item<span class="sh_symbol">=[</span>u<span class="sh_string">'a'</span><span class="sh_symbol">,</span> <span class="sh_number">2</span><span class="sh_symbol">])</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_symbol">(</span>item<span class="sh_symbol">=[</span>u<span class="sh_string">'a'</span><span class="sh_symbol">,</span> <span class="sh_number">3</span><span class="sh_symbol">])</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_symbol">(</span>item<span class="sh_symbol">=[</span>u<span class="sh_string">'b'</span><span class="sh_symbol">,</span> <span class="sh_number">1</span><span class="sh_symbol">])</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_symbol">(</span>item<span class="sh_symbol">=[</span>u<span class="sh_string">'b'</span><span class="sh_symbol">,</span> <span class="sh_number">2</span><span class="sh_symbol">])</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_symbol">(</span>item<span class="sh_symbol">=[</span>u<span class="sh_string">'b'</span><span class="sh_symbol">,</span> <span class="sh_number">3</span><span class="sh_symbol">])</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_symbol">(</span>item<span class="sh_symbol">=[</span>u<span class="sh_string">'c'</span><span class="sh_symbol">,</span> <span class="sh_number">1</span><span class="sh_symbol">])</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_symbol">(</span>item<span class="sh_symbol">=[</span>u<span class="sh_string">'c'</span><span class="sh_symbol">,</span> <span class="sh_number">2</span><span class="sh_symbol">])</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>web2<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_symbol">(</span>item<span class="sh_symbol">=[</span>u<span class="sh_string">'c'</span><span class="sh_symbol">,</span> <span class="sh_number">3</span><span class="sh_symbol">])</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY RECAP <span class="sh_symbol">**************************************************************************************************************</span></li><li>web2                       <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">2</span>    changed<span class="sh_symbol">=</span><span class="sh_number">1</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>   </li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# vim add1.yml 
---
- hosts: web2
  remote_user: root
  vars:
    un: [a, b, c]
    id: [1, 2, 3]
  tasks:
    - name: add users
      shell: echo {{item}}
      with_nested:
        - "{{un}}"
        - "{{id}}"

 [root@ansible ansible]# ansible-playbook add1.yml 

PLAY [web2] *************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************
ok: [web2]

TASK [add users] ********************************************************************************************************
changed: [web2] =&gt; (item=[u'a', 1])
changed: [web2] =&gt; (item=[u'a', 2])
changed: [web2] =&gt; (item=[u'a', 3])
changed: [web2] =&gt; (item=[u'b', 1])
changed: [web2] =&gt; (item=[u'b', 2])
changed: [web2] =&gt; (item=[u'b', 3])
changed: [web2] =&gt; (item=[u'c', 1])
changed: [web2] =&gt; (item=[u'c', 2])
changed: [web2] =&gt; (item=[u'c', 3])

PLAY RECAP **************************************************************************************************************
web2                       : ok=2    changed=1    unreachable=0    failed=0   
</pre></div></div>
      <p class="number">步骤四：tags给指定的任务定义一个调用标识</p>
      <p>1）tags 样例</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim adhttp<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> cache</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  tasks<span class="sh_symbol">:</span></li><li>    <span class="sh_symbol">-</span> copy<span class="sh_symbol">:</span></li><li>        src<span class="sh_symbol">:</span> <span class="sh_regexp">/root/</span>httpd<span class="sh_symbol">.</span>conf</li><li>        dest<span class="sh_symbol">:</span>  <span class="sh_regexp">/etc/</span><span class="sh_normal">httpd</span><span class="sh_symbol">/</span><span class="sh_normal">conf</span><span class="sh_symbol">/</span>httpd<span class="sh_symbol">.</span>conf</li><li>        owner<span class="sh_symbol">:</span> root</li><li>        group<span class="sh_symbol">:</span> root</li><li>        mode<span class="sh_symbol">:</span> <span class="sh_number">0644</span></li><li>      tags<span class="sh_symbol">:</span> config_httpd</li><li>      notify<span class="sh_symbol">:</span></li><li>        <span class="sh_symbol">-</span> restart httpd</li><li>  handlers<span class="sh_symbol">:</span></li><li>     <span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> restart httpd</li><li>       service<span class="sh_symbol">:</span> name<span class="sh_symbol">=</span>httpd state<span class="sh_symbol">=</span>restarted</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# vim adhttp.yml
---
- hosts: cache
  remote_user: root
  tasks:
    - copy:
        src: /root/httpd.conf
        dest:  /etc/httpd/conf/httpd.conf
        owner: root
        group: root
        mode: 0644
      tags: config_httpd
      notify:
        - restart httpd
  handlers:
     - name: restart httpd
       service: name=httpd state=restarted

</pre></div></div>
      <p>2）调用方式</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook adhttp<span class="sh_symbol">.</span>yml  <span class="sh_symbol">--</span>tags<span class="sh_symbol">=</span>config_httpd</li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span> <span class="sh_symbol">*****************************************************************</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]</span> <span class="sh_symbol">*******************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>copy<span class="sh_symbol">]</span> <span class="sh_symbol">******************************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY RECAP <span class="sh_symbol">*******************************************************************</span></li><li>cache                      <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">2</span>    changed<span class="sh_symbol">=</span><span class="sh_number">0</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# ansible-playbook adhttp.yml  --tags=config_httpd

PLAY [cache] *****************************************************************

TASK [Gathering Facts] *******************************************************
ok: [cache]

TASK [copy] ******************************************************************
ok: [cache]

PLAY RECAP *******************************************************************
cache                      : ok=2    changed=0    unreachable=0    failed=0

</pre></div></div>
      <p>3）include and roles</p>
      <p>在编写playbook的时候随着项目越来越大，playbook越来越复杂。可以把一些play、task 或 handler放到其他文件中，通过包含进来是一个不错的选择</p>
      <p>roles像是加强版的include，它可以引入一个项目的文件和目录</p>
      <p>一般所需的目录层级有</p>
      <p>vars：变量层</p>
      <p>tasks：任务层</p>
      <p>handlers：触发条件</p>
      <p>files：文件</p>
      <p>template：模板</p>
      <p>default：默认，优先级最低</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">...</span></li><li>tasks<span class="sh_symbol">:</span></li><li>   <span class="sh_symbol">-</span> include<span class="sh_symbol">:</span> <span class="sh_normal">tasks</span><span class="sh_symbol">/</span>setup<span class="sh_symbol">.</span>yml</li><li>   <span class="sh_symbol">-</span> include<span class="sh_symbol">:</span> <span class="sh_normal">tasks</span><span class="sh_symbol">/</span>users<span class="sh_symbol">.</span>yml user<span class="sh_symbol">=</span>plj </li><li><span class="sh_comment">//users.yml 中可以通过{{ user }}来使用这些变量</span></li><li>handlers<span class="sh_symbol">:</span></li><li>  <span class="sh_symbol">-</span> include<span class="sh_symbol">:</span> <span class="sh_normal">handlers</span><span class="sh_symbol">/</span>handlers<span class="sh_symbol">.</span>yml</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">...
tasks:
   - include: tasks/setup.yml
   - include: tasks/users.yml user=plj 
//users.yml 中可以通过{{ user }}来使用这些变量
handlers:
  - include: handlers/handlers.yml
</pre></div></div>
      <p class="number">步骤五：debug检测</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/ARCHITECTURE/DAY02/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook  <span class="sh_symbol">--</span>syntax<span class="sh_symbol">-</span>check  http<span class="sh_symbol">.</span>yml  <span class="sh_comment">//检测语法</span></li><li><span style="display:none;">&nbsp;</span></li><li>playbook<span class="sh_symbol">:</span> http<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook  <span class="sh_symbol">-</span>C  http<span class="sh_symbol">.</span>yml   <span class="sh_comment">//测试运行</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook   http<span class="sh_symbol">.</span>yml  <span class="sh_symbol">--</span>list<span class="sh_symbol">-</span>tasks  </li><li><span class="sh_comment">//显示要执行的工作</span></li><li><span style="display:none;">&nbsp;</span></li><li>playbook<span class="sh_symbol">:</span> http<span class="sh_symbol">.</span>yml</li><li><span style="display:none;">&nbsp;</span></li><li>  play #<span class="sh_number">1</span> <span class="sh_symbol">(</span>cache<span class="sh_symbol">):</span> cache&nbsp;&nbsp;&nbsp;&nbsp;TAGS<span class="sh_symbol">:</span> <span class="sh_symbol">[]</span></li><li>    tasks<span class="sh_symbol">:</span></li><li>      install one specific version of Apache&nbsp;&nbsp;&nbsp;&nbsp;TAGS<span class="sh_symbol">:</span> <span class="sh_symbol">[]</span></li><li>      lineinfile&nbsp;&nbsp;&nbsp;&nbsp;TAGS<span class="sh_symbol">:</span> <span class="sh_symbol">[]</span></li><li>      replace&nbsp;&nbsp;&nbsp;&nbsp;TAGS<span class="sh_symbol">:</span> <span class="sh_symbol">[]</span></li><li>      service&nbsp;&nbsp;&nbsp;&nbsp;TAGS<span class="sh_symbol">:</span> <span class="sh_symbol">[]</span></li><li>      copy&nbsp;&nbsp;&nbsp;&nbsp;TAGS<span class="sh_symbol">:</span> <span class="sh_symbol">[]</span></li><li><span style="display:none;">&nbsp;</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># vim debug<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> hosts<span class="sh_symbol">:</span> cache</li><li>  remote_user<span class="sh_symbol">:</span> root</li><li>  tasks<span class="sh_symbol">:</span></li><li>    <span class="sh_symbol">-</span> shell<span class="sh_symbol">:</span> uptime <span class="sh_symbol">|</span>awk <span class="sh_string">'{printf("%f</span><span class="sh_specialchar">\n</span><span class="sh_string">",$(NF-2))}'</span></li><li>      register<span class="sh_symbol">:</span> result</li><li>    <span class="sh_symbol">-</span> shell<span class="sh_symbol">:</span> <span class="sh_normal">touch </span><span class="sh_symbol">/</span><span class="sh_normal">tmp</span><span class="sh_symbol">/</span>isreboot</li><li>      when<span class="sh_symbol">:</span> result<span class="sh_symbol">.</span>stdout<span class="sh_symbol">|</span>float <span class="sh_symbol">&gt;</span> <span class="sh_number">0.5</span></li><li>    <span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> Show debug info</li><li>      debug<span class="sh_symbol">:</span> <span class="sh_keyword">var</span><span class="sh_symbol">=</span>result</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@ansible ansible<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook debug<span class="sh_symbol">.</span>yml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//运行</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span> <span class="sh_symbol">************************************************************************************************************</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]</span> <span class="sh_symbol">**************************************************************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>command<span class="sh_symbol">]</span> <span class="sh_symbol">**********************************************************************************************************</span></li><li>changed<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>command<span class="sh_symbol">]</span> <span class="sh_symbol">**********************************************************************************************************</span></li><li>skipping<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span></li><li><span style="display:none;">&nbsp;</span></li><li>TASK <span class="sh_symbol">[</span>Show debug info<span class="sh_symbol">]</span> <span class="sh_symbol">**************************************************************************************************</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>cache<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_cbracket">{</span></li><li>    <span class="sh_string">"result"</span><span class="sh_symbol">:</span> <span class="sh_cbracket">{</span></li><li>        <span class="sh_string">"changed"</span><span class="sh_symbol">:</span> <span class="sh_keyword">true</span><span class="sh_symbol">,</span> </li><li>        <span class="sh_string">"cmd"</span><span class="sh_symbol">:</span> <span class="sh_string">"uptime |awk '{printf(</span><span class="sh_specialchar">\"</span><span class="sh_string">%f</span><span class="sh_specialchar">\\</span><span class="sh_string">n</span><span class="sh_specialchar">\"</span><span class="sh_string">,$(NF-2))}'"</span><span class="sh_symbol">,</span> </li><li>        <span class="sh_string">"delta"</span><span class="sh_symbol">:</span> <span class="sh_string">"0:00:00.005905"</span><span class="sh_symbol">,</span> </li><li>        <span class="sh_string">"end"</span><span class="sh_symbol">:</span> <span class="sh_string">"2018-09-07 12:57:51.371013"</span><span class="sh_symbol">,</span> </li><li>        <span class="sh_string">"failed"</span><span class="sh_symbol">:</span> <span class="sh_keyword">false</span><span class="sh_symbol">,</span> </li><li>        <span class="sh_string">"rc"</span><span class="sh_symbol">:</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> </li><li>        <span class="sh_string">"start"</span><span class="sh_symbol">:</span> <span class="sh_string">"2018-09-07 12:57:51.365108"</span><span class="sh_symbol">,</span> </li><li>        <span class="sh_string">"stderr"</span><span class="sh_symbol">:</span> <span class="sh_string">""</span><span class="sh_symbol">,</span> </li><li>        <span class="sh_string">"stderr_lines"</span><span class="sh_symbol">:</span> <span class="sh_symbol">[],</span> </li><li>        <span class="sh_string">"stdout"</span><span class="sh_symbol">:</span> <span class="sh_string">"0.000000"</span><span class="sh_symbol">,</span> </li><li>        <span class="sh_string">"stdout_lines"</span><span class="sh_symbol">:</span> <span class="sh_symbol">[</span></li><li>            <span class="sh_string">"0.000000"</span></li><li>        <span class="sh_symbol">]</span></li><li>    <span class="sh_cbracket">}</span></li><li><span class="sh_cbracket">}</span></li><li><span style="display:none;">&nbsp;</span></li><li>PLAY RECAP <span class="sh_symbol">**************************************************************************************************************</span></li><li>cache                      <span class="sh_symbol">:</span> ok<span class="sh_symbol">=</span><span class="sh_number">3</span>    changed<span class="sh_symbol">=</span><span class="sh_number">1</span>    unreachable<span class="sh_symbol">=</span><span class="sh_number">0</span>    failed<span class="sh_symbol">=</span><span class="sh_number">0</span>   </li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@ansible ansible]# ansible-playbook  --syntax-check  http.yml  //检测语法

playbook: http.yml
[root@ansible ansible]# ansible-playbook  -C  http.yml   //测试运行

[root@ansible ansible]# ansible-playbook   http.yml  --list-tasks  
//显示要执行的工作

playbook: http.yml

  play #1 (cache): cache	TAGS: []
    tasks:
      install one specific version of Apache	TAGS: []
      lineinfile	TAGS: []
      replace	TAGS: []
      service	TAGS: []
      copy	TAGS: []


[root@ansible ansible]# vim debug.yml
---
- hosts: cache
  remote_user: root
  tasks:
    - shell: uptime |awk '{printf("%f\n",$(NF-2))}'
      register: result
    - shell: touch /tmp/isreboot
      when: result.stdout|float &gt; 0.5
    - name: Show debug info
      debug: var=result

[root@ansible ansible]# ansible-playbook debug.yml 		//运行

PLAY [cache] ************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************
ok: [cache]

TASK [command] **********************************************************************************************************
changed: [cache]

TASK [command] **********************************************************************************************************
skipping: [cache]

TASK [Show debug info] **************************************************************************************************
ok: [cache] =&gt; {
    "result": {
        "changed": true, 
        "cmd": "uptime |awk '{printf(\"%f\\n\",$(NF-2))}'", 
        "delta": "0:00:00.005905", 
        "end": "2018-09-07 12:57:51.371013", 
        "failed": false, 
        "rc": 0, 
        "start": "2018-09-07 12:57:51.365108", 
        "stderr": "", 
        "stderr_lines": [], 
        "stdout": "0.000000", 
        "stdout_lines": [
            "0.000000"
        ]
    }
}

PLAY RECAP **************************************************************************************************************
cache                      : ok=3    changed=1    unreachable=0    failed=0   
</pre></div></div>
    </div>
  
</body></html>