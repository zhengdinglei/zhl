
<!-- saved from url=(0079)http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>CASE</title>
    
    <script type="text/javascript" src="./CASE_files/jquery.min.js">
    </script>
    <script type="text/javascript" src="./CASE_files/jquery.snippet.js">
    </script>
    <script type="text/javascript" src="./CASE_files/main.js">
    </script>
    <link type="text/css" href="./CASE_files/index.css" rel="Stylesheet">
    <link type="text/css" href="./CASE_files/jquery.snippet.css" rel="Stylesheet">
  </head>
  <body>
    <div class="source_style_case">
      <a name="page_top_case" id="top_anchor">
      </a><a id="link_top" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#page_top_case">Top</a>
      <h1>NSD SECURITY DAY01</h1>
      <ol class="index">
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#case1">案例1：Linux基本防护措施</a>
        </li>
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#case2">案例2：使用sudo分配管理权限</a>
        </li>
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#case3">案例3：提高SSH服务安全</a>
        </li>
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#case4">案例4：SELinux安全防护</a>
        </li>
      </ol>
      <a name="case1">
      </a>
      <h2>1 案例1：Linux基本防护措施</h2>
      <h3>1.1 问题</h3>
      <p>本案例要求练习Linux系统的基本防护措施，完成以下任务：</p>
      <ol class="list">
        <li>修改用户zhangsan的账号属性，设置为2019-12-31日失效（禁止登录）
</li>
        <li>临时锁定用户lisi的账户，使其无法登录，验证效果后解除锁定
</li>
        <li>修改tty终端提示，使得登录前看到的第一行文本为“Windows Server 2012 Enterprise R2”，第二行文本为“NT 6.2 Hybrid”
</li>
        <li>锁定文件/etc/resolv.conf、/etc/hosts，以防止其内容被无意中修改
</li>
      </ol>
      <h3>1.2 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一：修改用户zhangsan的账户属性，设置为2019-12-31日失效（禁止登录）</p>
      <p>1）正常情况下，未过期的账号可以正常登录，使用chage可以修改账户有效期。</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li>chage命令的语法格式：</li><li>chage –l&nbsp;&nbsp;&nbsp;&nbsp;账户名称&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//查看账户信息</span></li><li>chage –E 时间 账户名称&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//修改账户有效期</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">chage命令的语法格式：
chage –l	账户名称								//查看账户信息
chage –E 时间 账户名称							//修改账户有效期
</pre></div></div>
      <p>2）失效的用户将无法登录</p>
      <p>使用chage命令将用户zhangsan的账户设为当前已失效（比如已经过去的某个时间）：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># useradd zhangsan</li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># chage <span class="sh_symbol">-</span>E <span class="sh_number">2015-05-15</span> zhangsan</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# useradd zhangsan
[root@proxy ~]# chage -E 2015-05-15 zhangsan
</pre></div></div>
      <p>尝试以用户zhangsan重新登录，输入正确的用户名、密码后直接闪退，返回登录页，说明此帐号已失效。</p>
      <p>3）重设用户zhangsan的属性，将失效时间设为2019-12-31</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># chage <span class="sh_symbol">-</span>E <span class="sh_number">2019-12-31</span> zhangsan  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//修改失效日期</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># chage <span class="sh_symbol">-</span>l zhangsan    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//查看账户年龄信息</span></li><li>Last password change &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">:</span> May <span class="sh_number">15</span><span class="sh_symbol">,</span> <span class="sh_number">2017</span></li><li>Password expires   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">:</span> never</li><li>Password inactive   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">:</span> never</li><li>Account expires  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">:</span> Dec <span class="sh_number">31</span><span class="sh_symbol">,</span> <span class="sh_number">2019</span></li><li>Minimum number of days between password change  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">:</span> <span class="sh_number">0</span></li><li>Maximum number of days between password change   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">:</span> <span class="sh_number">99999</span></li><li><span class="sh_predef_func">Number</span> of days of warning before password expires &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">:</span> <span class="sh_number">7</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# chage -E 2019-12-31 zhangsan  			//修改失效日期
[root@proxy ~]# chage -l zhangsan    					//查看账户年龄信息
Last password change 					: May 15, 2017
Password expires   					: never
Password inactive   					: never
Account expires  						: Dec 31, 2019
Minimum number of days between password change  		: 0
Maximum number of days between password change   		: 99999
Number of days of warning before password expires 		: 7
</pre></div></div>
      <p>4）定义默认有效期（扩展知识）</p>
      <p>/etc/login.defs这个配置文件，决定了账户密码的默认有效期。</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">cat </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>login<span class="sh_symbol">.</span>defs</li><li>PASS_MAX_DAYS&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_number">99999</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//密码最长有效期</span></li><li>PASS_MIN_DAYS&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_number">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//密码最短有效期</span></li><li>PASS_MIN_LEN&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_number">5</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//密码最短长度</span></li><li>PASS_WARN_AGE&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_number">7</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//密码过期前几天提示警告信息</span></li><li>UID_MIN                  <span class="sh_number">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//UID最小值</span></li><li>UID_MAX                  <span class="sh_number">60000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//UID最大值</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# cat /etc/login.defs
PASS_MAX_DAYS	99999						//密码最长有效期
PASS_MIN_DAYS	0							//密码最短有效期
PASS_MIN_LEN	5							//密码最短长度
PASS_WARN_AGE	7							//密码过期前几天提示警告信息
UID_MIN                  1000				//UID最小值
UID_MAX                  60000				//UID最大值
</pre></div></div>
      <p class="number">步骤二：临时锁定用户zhangsan的账户，使其无法登录，验证效果后解除锁定</p>
      <p>1）锁定用户账号</p>
      <p>使用passwd或usermod命令将用户zhangsan的账户锁定。</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># passwd <span class="sh_symbol">-</span>l zhangsan   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//锁定用户账号lock</span></li><li>锁定用户 zhangsan 的密码。</li><li>passwd<span class="sh_symbol">:</span> 操作成功</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># passwd <span class="sh_symbol">-</span>S zhangsan  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//查看状态status</span></li><li>zhangsan LK <span class="sh_number">2018-02-22</span> <span class="sh_number">0</span> <span class="sh_number">99999</span> <span class="sh_number">7</span> <span class="sh_symbol">-</span><span class="sh_number">1</span> <span class="sh_symbol">(</span>密码已被锁定。<span class="sh_symbol">)</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# passwd -l zhangsan   					//锁定用户账号lock
锁定用户 zhangsan 的密码。
passwd: 操作成功

[root@proxy ~]# passwd -S zhangsan  					//查看状态status
zhangsan LK 2018-02-22 0 99999 7 -1 (密码已被锁定。)
</pre></div></div>
      <p>2）验证用户zhangsan已无法登录，说明锁定生效</p>
      <p>输入正确的用户名、密码，始终提示“Login incorrect”，无法登录。</p>
      <p>3）解除对用户zhangsan的锁定</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># passwd <span class="sh_symbol">-</span>u zhangsan   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//解锁用户账号</span></li><li>解锁用户 zhangsan 的密码 。</li><li>passwd<span class="sh_symbol">:</span> 操作成功</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># passwd <span class="sh_symbol">-</span>S zhangsan  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//查看状态</span></li><li>zhangsan PS <span class="sh_number">2018-08-14</span> <span class="sh_number">0</span> <span class="sh_number">99999</span> <span class="sh_number">7</span> <span class="sh_symbol">-</span><span class="sh_number">1</span> <span class="sh_symbol">(</span>密码已设置，使用 SHA512 加密。<span class="sh_symbol">)</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# passwd -u zhangsan   					//解锁用户账号
解锁用户 zhangsan 的密码 。
passwd: 操作成功

[root@proxy ~]# passwd -S zhangsan  					//查看状态
zhangsan PS 2018-08-14 0 99999 7 -1 (密码已设置，使用 SHA512 加密。)
</pre></div></div>
      <p class="number">步骤三：修改tty登录的提示信息，隐藏系统版本</p>
      <p>1）账户在登录Linux系统时，默认会显示登陆信息（包括操作系统内核信息）</p>
      <p>/etc/issue这个配置文件里保存的就是这些登陆信息，修改该文件防止内核信息泄露。</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">cat </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>issue  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//确认原始文件</span></li><li>Red Hat Enterprise Linux Server release <span class="sh_number">6.5</span> <span class="sh_symbol">(</span>Santiago<span class="sh_symbol">)</span></li><li>Kernel <span class="sh_symbol">\</span>r on an <span class="sh_symbol">\</span>m</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">cp </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span><span class="sh_normal">issue </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>issue<span class="sh_symbol">.</span>origin  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//备份文件</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>issue  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//修改文件内容</span></li><li>Windows Server <span class="sh_number">2012</span> Enterprise R2</li><li>NT <span class="sh_number">6.2</span> Hybrid</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# cat /etc/issue  							//确认原始文件
Red Hat Enterprise Linux Server release 6.5 (Santiago)
Kernel \r on an \m

[root@proxy ~]# cp /etc/issue /etc/issue.origin  			//备份文件

[root@proxy ~]# vim /etc/issue  							//修改文件内容
Windows Server 2012 Enterprise R2
NT 6.2 Hybrid
</pre></div></div>
      <p>2）测试版本伪装效果</p>
      <p>退出已登录的tty终端，或者重启Linux系统，刷新后的终端提示信息会变成自定义的文本内容，如图-1所示。</p>
      <div class="image">
        <img src="./CASE_files/image001.png">
        <p>图-1</p>
      </div>
      <p>附加：对于操作系统来说，文件系统也可以通过添加额外属性来提高性能与安全性。</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">cat </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>fstab</li><li><span class="sh_regexp">/dev/</span><span class="sh_normal">vda1   </span><span class="sh_symbol">/</span>boot    xfs   defaults<span class="sh_symbol">,</span>noexec   <span class="sh_number">0</span>  <span class="sh_number">0</span></li><li><span class="sh_regexp">/dev/</span><span class="sh_normal">vda3   </span><span class="sh_symbol">/</span>home    xfs   defaults<span class="sh_symbol">,</span>noatime  <span class="sh_number">0</span>  <span class="sh_number">0</span></li><li>备注：</li><li>noexec属性可以让分区下的所有程序都不可执行，包括病毒与木马</li><li>noatime让分区下的所有文件都不再更新atime时间，atime时间为文件的访问时间</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# cat /etc/fstab
/dev/vda1   /boot    xfs   defaults,noexec   0  0
/dev/vda3   /home    xfs   defaults,noatime  0  0
备注：
noexec属性可以让分区下的所有程序都不可执行，包括病毒与木马
noatime让分区下的所有文件都不再更新atime时间，atime时间为文件的访问时间
</pre></div></div>
      <p class="number">步骤四：锁定文件/etc/resolv.conf、/etc/hosts</p>
      <p>1）语法格式：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li># chattr <span class="sh_symbol">+</span>i  文件名&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//锁定文件（无法修改、删除等）</span></li><li># chattr <span class="sh_symbol">-</span>i  文件名&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//解锁文件</span></li><li># chattr <span class="sh_symbol">+</span>a  文件名&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//锁定后文件仅可追加</span></li><li># chattr <span class="sh_symbol">-</span>a  文件名&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//解锁文件</span></li><li># lsattr 文件名&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//查看文件特殊属性</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;"># chattr +i  文件名					//锁定文件（无法修改、删除等）
# chattr -i  文件名					//解锁文件
# chattr +a  文件名					//锁定后文件仅可追加
# chattr -a  文件名					//解锁文件
# lsattr 文件名						//查看文件特殊属性
</pre></div></div>
      <p>2) 使用+i锁定文件，使用lsattr查看属性</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># chattr <span class="sh_symbol">+</span><span class="sh_normal">i </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>resolv<span class="sh_symbol">.</span>conf </li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">lsattr </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>resolv<span class="sh_symbol">.</span>conf </li><li><span class="sh_symbol">----</span>i<span class="sh_symbol">----------</span><span class="sh_normal"> </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>resolv<span class="sh_symbol">.</span>conf</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# chattr +i /etc/resolv.conf 
[root@proxy ~]# lsattr /etc/resolv.conf 
----i---------- /etc/resolv.conf
</pre></div></div>
      <p>3）使用+a锁定文件(仅可追加)，使用lsattr查看属性</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># chattr <span class="sh_symbol">+</span><span class="sh_normal">a </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>hosts</li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">lsattr </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>hosts</li><li><span class="sh_symbol">-----</span>a<span class="sh_symbol">----------</span><span class="sh_normal"> </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>hosts</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# chattr +a /etc/hosts
[root@proxy ~]# lsattr /etc/hosts
-----a---------- /etc/hosts
</pre></div></div>
      <p>4）测试文件锁定效果</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># rm <span class="sh_symbol">-</span><span class="sh_normal">rf </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>resolv<span class="sh_symbol">.</span>conf</li><li>rm<span class="sh_symbol">:</span> 无法删除<span class="sh_string">"/etc/resolv.conf"</span><span class="sh_symbol">:</span> 不允许的操作</li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># echo xyz <span class="sh_symbol">&gt;</span> <span class="sh_regexp">/etc/</span>resolv<span class="sh_symbol">.</span>conf</li><li><span class="sh_symbol">-</span>bash<span class="sh_symbol">:</span> resolv<span class="sh_symbol">.</span>conf<span class="sh_symbol">:</span> 权限不够</li><li><span style="display:none;">&nbsp;</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># rm <span class="sh_symbol">-</span><span class="sh_normal">rf  </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>hosts    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="sh_comment">//失败</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># echo <span class="sh_string">"192.168.4.1  xyz"</span> <span class="sh_symbol">&gt;</span> <span class="sh_regexp">/etc/</span>hosts     <span class="sh_comment">//失败</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># echo <span class="sh_string">"192.168.4.1  xyz"</span> <span class="sh_symbol">&gt;&gt;</span> <span class="sh_regexp">/etc/</span>hosts    <span class="sh_comment">//成功</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# rm -rf /etc/resolv.conf
rm: 无法删除"/etc/resolv.conf": 不允许的操作
[root@proxy ~]# echo xyz &gt; /etc/resolv.conf
-bash: resolv.conf: 权限不够


[root@proxy ~]# rm -rf  /etc/hosts    					 //失败
[root@proxy ~]# echo "192.168.4.1  xyz" &gt; /etc/hosts     //失败
[root@proxy ~]# echo "192.168.4.1  xyz" &gt;&gt; /etc/hosts    //成功
</pre></div></div>
      <p>5）恢复这两个文件原有的属性（避免对后续实验造成影响）</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># chattr <span class="sh_symbol">-</span><span class="sh_normal">i </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>resolv<span class="sh_symbol">.</span>conf </li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># chattr <span class="sh_symbol">-</span><span class="sh_normal">i </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>hosts</li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">lsattr </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>resolv<span class="sh_symbol">.</span><span class="sh_normal">conf </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>hosts</li><li><span class="sh_symbol">---------------</span><span class="sh_normal"> </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>resolv<span class="sh_symbol">.</span>conf</li><li><span class="sh_symbol">---------------</span><span class="sh_normal"> </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>hosts</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# chattr -i /etc/resolv.conf 
[root@proxy ~]# chattr -i /etc/hosts
[root@proxy ~]# lsattr /etc/resolv.conf /etc/hosts
--------------- /etc/resolv.conf
--------------- /etc/hosts
</pre></div></div>
      <a name="case2">
      </a>
      <h2>2 案例2：使用sudo分配管理权限</h2>
      <h3>2.1 问题</h3>
      <p>本案例要求利用sudo机制分配管理操作权限，主要完成以下任务：</p>
      <ol class="list">
        <li>使用su命令临时切换账户身份，并执行命令
</li>
        <li>允许softadm管理系统服务的权限
</li>
        <li>允许用户useradm通过sudo方式添加/删除/修改除root以外的用户账号
</li>
        <li>允许wheel组成员以特权执行所有命令
</li>
        <li>为sudo机制启用日志记录，以便跟踪sudo执行操作
</li>
      </ol>
      <h3>2.2 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一：使用su命令临时切换账户身份，并以root执行命令</p>
      <p>su(Substitute User)命令可以快速切换账户身份，普通用户切换账户身份时需要输入密码，root使用su命令切换任何身份都不需要密码，如法格式如下：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li># su <span class="sh_symbol">-</span>  <span class="sh_symbol">[</span>账户名称<span class="sh_symbol">]</span></li><li># su <span class="sh_symbol">-</span>  <span class="sh_symbol">[</span>账户名称<span class="sh_symbol">]</span>  <span class="sh_symbol">-</span>c <span class="sh_string">'命令'</span>  </li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;"># su -  [账户名称]
# su -  [账户名称]  -c '命令'  
</pre></div></div>
      <p>1)从普通用户切换为root账户身份(如果没有普通账户则需要先创建)</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>zhangsan@proxy <span class="sh_symbol">~]</span># whoami</li><li>zhangsan</li><li><span class="sh_symbol">[</span>zhangsan@proxy <span class="sh_symbol">~]</span># su <span class="sh_symbol">-</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//切换账户，默认切换为root账户</span></li><li>密码<span class="sh_symbol">:</span>                                          <span class="sh_comment">//输入root的密码</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># whoami&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//确认结果</span></li><li>root</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[zhangsan@proxy ~]# whoami
zhangsan
[zhangsan@proxy ~]# su -					//切换账户，默认切换为root账户
密码:                                          //输入root的密码
[root@proxy ~]# whoami					//确认结果
root
</pre></div></div>
      <p>2)以普通身份创建文件(如果没有普通账户则需要先创建)，以root身份重启服务</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># su <span class="sh_symbol">-</span> zhangsan  <span class="sh_symbol">-</span>c <span class="sh_string">"touch /tmp/test.txt"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//管理员切换普通用户</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">ll  </span><span class="sh_symbol">/</span><span class="sh_normal">tmp</span><span class="sh_symbol">/</span>test<span class="sh_symbol">.</span>txt</li><li><span style="display:none;">&nbsp;</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>zhangsan@proxy <span class="sh_symbol">~]</span># su <span class="sh_symbol">-</span> <span class="sh_symbol">-</span>c <span class="sh_string">"systemctl restart sshd"</span>&nbsp;&nbsp;&nbsp;&nbsp;    <span class="sh_comment">//以管理员重启服务</span></li><li>密码：</li><li>● sshd<span class="sh_symbol">.</span>service <span class="sh_symbol">-</span> OpenSSH server daemon</li><li>Loaded<span class="sh_symbol">:</span> <span class="sh_function">loaded</span> <span class="sh_symbol">(</span><span class="sh_regexp">/usr/</span><span class="sh_normal">lib</span><span class="sh_symbol">/</span><span class="sh_normal">systemd</span><span class="sh_symbol">/</span><span class="sh_normal">system</span><span class="sh_symbol">/</span>sshd<span class="sh_symbol">.</span>service<span class="sh_symbol">;</span> enabled<span class="sh_symbol">;</span> vendor preset<span class="sh_symbol">:</span> enabled<span class="sh_symbol">)</span></li><li>active<span class="sh_symbol">:</span> <span class="sh_function">active</span> <span class="sh_symbol">(</span>running<span class="sh_symbol">)</span> since 五 <span class="sh_number">2018-01-19</span> <span class="sh_number">08</span><span class="sh_symbol">:</span><span class="sh_number">59</span><span class="sh_symbol">:</span><span class="sh_number">40</span> CST<span class="sh_symbol">;</span> <span class="sh_number">1</span> months <span class="sh_number">4</span> days ago</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# su - zhangsan  -c "touch /tmp/test.txt"		//管理员切换普通用户
[root@proxy ~]# ll  /tmp/test.txt


[zhangsan@proxy ~]# su - -c "systemctl restart sshd"	    //以管理员重启服务
密码：
● sshd.service - OpenSSH server daemon
Loaded: loaded (/usr/lib/systemd/system/sshd.service; enabled; vendor preset: enabled)
active: active (running) since 五 2018-01-19 08:59:40 CST; 1 months 4 days ago
</pre></div></div>
      <p class="number">步骤二：允许softadm管理系统服务的权限</p>
      <p>1）修改/etc/sudoers配置</p>
      <p>修改/etc/sudoers可以直接使用vim编辑该文件，或使用visudo命令修改该文件。</p>
      <p>为softadm授予相关脚本的执行权限，允许通过systemctl工具来管理系统服务。</p>
      <p>如果没有softadm账户可以先创建该账户。</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># useradd softadm</li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>sudoers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//修改文件后，需要使用wq强制保存</span></li><li><span class="sh_symbol">..</span> <span class="sh_symbol">..</span></li><li>softadm    ALL<span class="sh_symbol">=(</span>ALL<span class="sh_symbol">)</span><span class="sh_normal">   </span><span class="sh_symbol">/</span><span class="sh_normal">usr</span><span class="sh_symbol">/</span><span class="sh_normal">bin</span><span class="sh_symbol">/</span>systemctl &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li><li><span class="sh_comment">//授权softadm以root身份执行systemctl命令（ALL包括root）</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# useradd softadm
[root@proxy ~]# vim /etc/sudoers			//修改文件后，需要使用wq强制保存
.. ..
softadm    ALL=(ALL)   /usr/bin/systemctl 		
//授权softadm以root身份执行systemctl命令（ALL包括root）
</pre></div></div>
      <p>2）切换为softadm用户，并验证sudo执行权限</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># su <span class="sh_symbol">-</span> softadm</li><li><span class="sh_symbol">[</span>softadm@proxy <span class="sh_symbol">~]</span>$ sudo <span class="sh_symbol">-</span>l</li><li>… …</li><li><span class="sh_symbol">[</span>sudo<span class="sh_symbol">]</span> password <span class="sh_keyword">for</span> softadm<span class="sh_symbol">:</span>    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     <span class="sh_comment">//输入softadm的口令</span></li><li><span class="sh_symbol">..</span> <span class="sh_symbol">..</span></li><li>用户 softadm 可以在该主机上运行以下命令：</li><li>    <span class="sh_symbol">(</span>ALL<span class="sh_symbol">)</span><span class="sh_normal"> </span><span class="sh_symbol">/</span><span class="sh_normal">usr</span><span class="sh_symbol">/</span><span class="sh_normal">bin</span><span class="sh_symbol">/</span>systemctl</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>softadm@proxy <span class="sh_symbol">~]</span>$ systemctl start httpd    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//不用sudo时启动服务失败</span></li><li>Authentication is required</li><li><span class="sh_symbol">..</span> <span class="sh_symbol">..</span></li><li><span class="sh_symbol">[</span>softadm@proxy <span class="sh_symbol">~]</span>$ sudo systemctl restart httpd  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//通过sudo启动服务成功</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# su - softadm
[softadm@proxy ~]$ sudo -l
… …
[sudo] password for softadm:    						     //输入softadm的口令
.. ..
用户 softadm 可以在该主机上运行以下命令：
    (ALL) /usr/bin/systemctl

[softadm@proxy ~]$ systemctl start httpd    				//不用sudo时启动服务失败
Authentication is required
.. ..
[softadm@proxy ~]$ sudo systemctl restart httpd  		//通过sudo启动服务成功
</pre></div></div>
      <p class="number">步骤三：允许用户useradm通过sudo方式添加/删除/修改除root以外的用户账号</p>
      <p>1）修改/etc/sudoers配置</p>
      <p>为useradm授予用户管理相关命令的执行权限，例外程序以!符号取反，放在后面。在执行相关程序时，可以利用通配符*。</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># useradd useradm</li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>sudoers</li><li><span class="sh_symbol">..</span> <span class="sh_symbol">..</span></li><li>useradm ALL<span class="sh_symbol">=(</span>ALL<span class="sh_symbol">)</span><span class="sh_normal">  </span><span class="sh_symbol">/</span><span class="sh_normal">usr</span><span class="sh_symbol">/</span><span class="sh_normal">bin</span><span class="sh_symbol">/</span>passwd<span class="sh_symbol">,!</span><span class="sh_regexp">/usr/</span><span class="sh_normal">bin</span><span class="sh_symbol">/</span>passwd root<span class="sh_symbol">,</span><span class="sh_regexp">/usr/</span><span class="sh_normal">sbin</span><span class="sh_symbol">/</span>user<span class="sh_symbol">*,</span></li><li> <span class="sh_symbol">!</span><span class="sh_regexp">/usr/</span><span class="sh_normal">sbin</span><span class="sh_symbol">/</span>user<span class="sh_symbol">*</span> <span class="sh_symbol">*</span> root</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# useradd useradm
[root@proxy ~]# vim /etc/sudoers
.. ..
useradm ALL=(ALL)  /usr/bin/passwd,!/usr/bin/passwd root,/usr/sbin/user*,
 !/usr/sbin/user* * root
</pre></div></div>
      <p>2）切换为useradm用户，验证sudo权限</p>
      <p>可以通过sudo方式来添加/删除/修改普通用户：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>useradm@proxy <span class="sh_symbol">~]</span>$ sudo <span class="sh_symbol">-</span>l</li><li><span class="sh_symbol">..</span> <span class="sh_symbol">..</span></li><li>用户useradm可以在该主机上运行以下命令：</li><li>    <span class="sh_symbol">(</span>root<span class="sh_symbol">)</span><span class="sh_normal"> </span><span class="sh_symbol">/</span><span class="sh_normal">usr</span><span class="sh_symbol">/</span><span class="sh_normal">bin</span><span class="sh_symbol">/</span>passwd<span class="sh_symbol">,</span> <span class="sh_symbol">!</span><span class="sh_regexp">/usr/</span><span class="sh_normal">bin</span><span class="sh_symbol">/</span>passwd root<span class="sh_symbol">,</span> <span class="sh_regexp">/usr/</span><span class="sh_normal">sbin</span><span class="sh_symbol">/</span>user<span class="sh_symbol">*,</span></li><li><span class="sh_symbol">!</span><span class="sh_regexp">/usr/</span><span class="sh_normal">sbin</span><span class="sh_symbol">/</span>user<span class="sh_symbol">*</span> <span class="sh_symbol">*</span> root</li><li><span class="sh_symbol">[</span>useradm@proxy <span class="sh_symbol">~]</span>$ sudo useradd newuser01  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//可以添加用户</span></li><li><span class="sh_symbol">[</span>useradm@proxy <span class="sh_symbol">~]</span>$ sudo passwd newuser01  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//可以修改普通用户的口令</span></li><li>更改用户 newuser01 的密码 。</li><li>新的 密码：</li><li>重新输入新的 密码：</li><li>passwd： 所有的身份验证令牌已经成功更新。</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[useradm@proxy ~]$ sudo -l
.. ..
用户useradm可以在该主机上运行以下命令：
    (root) /usr/bin/passwd, !/usr/bin/passwd root, /usr/sbin/user*,
!/usr/sbin/user* * root
[useradm@proxy ~]$ sudo useradd newuser01  				//可以添加用户
[useradm@proxy ~]$ sudo passwd newuser01  				//可以修改普通用户的口令
更改用户 newuser01 的密码 。
新的 密码：
重新输入新的 密码：
passwd： 所有的身份验证令牌已经成功更新。
</pre></div></div>
      <p>但是不能修改root用户的密码：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>useradm@proxy <span class="sh_symbol">~]</span>$ sudo passwd root</li><li>对不起，用户 useradm 无权以 root 的身份在 localhost 上</li><li>执行 <span class="sh_regexp">/usr/</span><span class="sh_normal">bin</span><span class="sh_symbol">/</span>passwd root。</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[useradm@proxy ~]$ sudo passwd root
对不起，用户 useradm 无权以 root 的身份在 localhost 上
执行 /usr/bin/passwd root。
</pre></div></div>
      <p class="number">步骤四：允许wheel组成员以特权执行所有命令</p>
      <p>此案例用来展示sudo的便利性及设置不当带来的危险性，生产环境下慎用。</p>
      <p>实现时参考下列操作(如果没有普通用户则先创建该账户)：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>sudoers</li><li><span class="sh_symbol">..</span> <span class="sh_symbol">..</span></li><li><span class="sh_symbol">%</span>wheel ALL<span class="sh_symbol">=(</span>ALL<span class="sh_symbol">)</span>  ALL</li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># usermod <span class="sh_symbol">-</span>a <span class="sh_symbol">-</span>G wheel zengye</li><li><span class="sh_symbol">[</span>zengye@proxy <span class="sh_symbol">~]</span>$ sudo <span class="sh_symbol">-</span>l</li><li><span class="sh_symbol">..</span> <span class="sh_symbol">..</span></li><li>用户 zengye 可以在该主机上运行以下命令：</li><li><span class="sh_symbol">(</span>root<span class="sh_symbol">)</span><span class="sh_normal"> </span><span class="sh_symbol">/</span>bin<span class="sh_comment">/*</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# vim /etc/sudoers
.. ..
%wheel ALL=(ALL)  ALL
[root@proxy ~]# usermod -a -G wheel zengye
[zengye@proxy ~]$ sudo -l
.. ..
用户 zengye 可以在该主机上运行以下命令：
(root) /bin/*
</pre></div></div>
      <p class="number">步骤五：为sudo机制启用日志记录，以便跟踪sudo执行操作</p>
      <p>1）修改/etc/sudoers配置，添加日志设置</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># visudo</li><li>Defaults  logfile<span class="sh_symbol">=</span><span class="sh_string">"/var/log/sudo"</span></li><li><span class="sh_symbol">..</span> <span class="sh_symbol">..</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# visudo
Defaults  logfile="/var/log/sudo"
.. ..
</pre></div></div>
      <p>2）以root（默认有所有权限）执行sudo操作</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># sudo <span class="sh_symbol">-</span>l  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//查看授权的sudo操作</span></li><li><span class="sh_symbol">[</span>softadm@proxy <span class="sh_symbol">~]</span># sudo systemctl status httpd  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//查看授权的sudo操作</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# sudo -l  								//查看授权的sudo操作
[softadm@proxy ~]# sudo systemctl status httpd  		//查看授权的sudo操作
</pre></div></div>
      <p>3）确认日志记录已生效</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">tail </span><span class="sh_symbol">/</span><span class="sh_keyword">var</span><span class="sh_regexp">/log/</span>sudo </li><li><span class="sh_symbol">..</span> <span class="sh_symbol">..</span></li><li>May <span class="sh_number">16</span> <span class="sh_number">22</span><span class="sh_symbol">:</span><span class="sh_number">14</span><span class="sh_symbol">:</span><span class="sh_number">49</span> <span class="sh_symbol">:</span> root <span class="sh_symbol">:</span> TTY<span class="sh_symbol">=</span><span class="sh_normal">pts</span><span class="sh_symbol">/</span><span class="sh_number">1</span> <span class="sh_symbol">;</span> PWD<span class="sh_symbol">=/</span>root <span class="sh_symbol">;</span> USER<span class="sh_symbol">=</span>root <span class="sh_symbol">;</span> COMMAND<span class="sh_symbol">=</span>list</li><li>Feb <span class="sh_number">22</span> <span class="sh_number">22</span><span class="sh_symbol">:</span><span class="sh_number">35</span><span class="sh_symbol">:</span><span class="sh_number">43</span> <span class="sh_symbol">:</span> softadm <span class="sh_symbol">:</span> TTY<span class="sh_symbol">=</span><span class="sh_normal">pts</span><span class="sh_symbol">/</span><span class="sh_number">11</span> <span class="sh_symbol">;</span> PWD<span class="sh_symbol">=</span><span class="sh_regexp">/home/</span>softadm <span class="sh_symbol">;</span> USER<span class="sh_symbol">=</span>root <span class="sh_symbol">;</span></li><li>    COMMAND<span class="sh_symbol">=</span><span class="sh_regexp">/bin/</span>systemctl status httpd</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# tail /var/log/sudo 
.. ..
May 16 22:14:49 : root : TTY=pts/1 ; PWD=/root ; USER=root ; COMMAND=list
Feb 22 22:35:43 : softadm : TTY=pts/11 ; PWD=/home/softadm ; USER=root ;
    COMMAND=/bin/systemctl status httpd
</pre></div></div>
      <a name="case3">
      </a>
      <h2>3 案例3：提高SSH服务安全</h2>
      <h3>3.1 问题</h3>
      <p>本案例要求提高Linux主机上SSH服务端的安全性，完成以下任务：</p>
      <ol class="list">
        <li>配置基本安全策略（禁止root、禁止空口令）
</li>
        <li>针对SSH访问采用仅允许的策略，未明确列出的用户一概拒绝登录
</li>
        <li>实现密钥验证登录（私钥口令）、免密码登入
</li>
        <li>确认密钥验证使用正常后，禁用口令验证
</li>
      </ol>
      <h3>3.2 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一：配置基本安全策略</p>
      <p>1）调整sshd服务配置，并重载服务</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span><span class="sh_normal">ssh</span><span class="sh_symbol">/</span>sshd_config</li><li><span class="sh_symbol">..</span> <span class="sh_symbol">..</span></li><li>Protocol <span class="sh_number">2</span>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//SSH协议</span></li><li>PermitRootLogin no  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//禁止root用户登录</span></li><li>PermitEmptyPasswords no  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//禁止密码为空的用户登录</span></li><li>UseDNS  no  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//不解析客户机地址</span></li><li>LoginGraceTime  1m  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//登录限时</span></li><li>MaxAuthTries  <span class="sh_number">3</span>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//每连接最多认证次数</span></li><li><span class="sh_symbol">..</span> <span class="sh_symbol">..</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># systemctl restart sshd</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# vim /etc/ssh/sshd_config
.. ..
Protocol 2  										//SSH协议
PermitRootLogin no  								//禁止root用户登录
PermitEmptyPasswords no  							//禁止密码为空的用户登录
UseDNS  no  										//不解析客户机地址
LoginGraceTime  1m  								//登录限时
MaxAuthTries  3  									//每连接最多认证次数
.. ..
[root@proxy ~]# systemctl restart sshd
</pre></div></div>
      <p>2）测试基本安全策略</p>
      <p>尝试以root用户SSH登录，失败：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># ssh root@<span class="sh_number">192.168.4.5</span></li><li>root@<span class="sh_number">192.168.4.5</span><span class="sh_string">'s password:</span></li><li><span class="sh_string">Permission denied, please try again.</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# ssh root@192.168.4.5
root@192.168.4.5's password:
Permission denied, please try again.
</pre></div></div>
      <p>将服务器上用户kate(如无该账户则先创建)的密码设为空，尝试SSH登录，也会失败：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># passwd <span class="sh_symbol">-</span>d kate  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//清空用户口令</span></li><li>清除用户的密码 kate。</li><li>passwd<span class="sh_symbol">:</span> 操作成功</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># ssh kate@<span class="sh_number">192.168.4.5</span></li><li>kate@<span class="sh_number">192.168.4.5</span><span class="sh_string">'s password:</span></li><li><span class="sh_string">Permission denied, please try again.</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# passwd -d kate  						//清空用户口令
清除用户的密码 kate。
passwd: 操作成功

[root@proxy ~]# ssh kate@192.168.4.5
kate@192.168.4.5's password:
Permission denied, please try again.
</pre></div></div>
      <p class="number">步骤二：针对SSH访问采用仅允许的策略，未明确列出的用户一概拒绝登录</p>
      <p>1）调整sshd服务配置，添加AllowUsers策略，仅允许用户zhangsan、tom、useradm，其中useradm只能从网段192.168.4.0/24登录。</p>
      <p>注意：如果没有这些用户，需要提前创建用户并设置密码。</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span><span class="sh_normal">ssh</span><span class="sh_symbol">/</span>sshd_config</li><li><span class="sh_symbol">..</span> <span class="sh_symbol">..</span></li><li>AllowUsers zhangsan tom useradm@<span class="sh_number">192.168.4.0</span><span class="sh_symbol">/</span><span class="sh_number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//定义账户白名单</span></li><li>##DenyUsers  USER1  USER2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//定义账户黑名单</span></li><li>##DenyGroups  GROUP1 GROUP2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//定义组黑名单</span></li><li>##AllowGroups  GROUP1 GROUP2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//定义组白名单</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># systemctl restart sshd</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# vim /etc/ssh/sshd_config
.. ..
AllowUsers zhangsan tom useradm@192.168.4.0/24			//定义账户白名单
##DenyUsers  USER1  USER2								//定义账户黑名单
##DenyGroups  GROUP1 GROUP2							//定义组黑名单
##AllowGroups  GROUP1 GROUP2							//定义组白名单
[root@proxy ~]# systemctl restart sshd
</pre></div></div>
      <p>2）验证SSH访问控制，未授权的用户将拒绝登录。</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># ssh useradm@<span class="sh_number">192.168.4.5</span>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//已授权的用户允许登录</span></li><li>useradm@<span class="sh_number">192.168.4.5</span><span class="sh_string">'s password:</span></li><li><span class="sh_string">[useradm@proxy ~]$ exit</span></li><li><span class="sh_string">[root@proxy ~]# ssh root@192.168.4.5  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//未授权的用户被拒绝登录</span></li><li><span class="sh_string">root@192.168.4.5'</span>s password<span class="sh_symbol">:</span></li><li>Permission denied<span class="sh_symbol">,</span> please <span class="sh_keyword">try</span> again<span class="sh_symbol">.</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# ssh useradm@192.168.4.5  			//已授权的用户允许登录
useradm@192.168.4.5's password:
[useradm@proxy ~]$ exit
[root@proxy ~]# ssh root@192.168.4.5  				//未授权的用户被拒绝登录
root@192.168.4.5's password:
Permission denied, please try again.
</pre></div></div>
      <p class="number">步骤三：实现密钥对验证登录（私钥口令）、免密码登入</p>
      <p>1）准备客户机测试环境</p>
      <p>为客户机的用户root建立SSH密钥对</p>
      <p>使用ssh-keygen创建密钥对，将私钥口令设为空（直接回车）：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span>$ ssh<span class="sh_symbol">-</span>keygen</li><li>Generating <span class="sh_keyword">public</span><span class="sh_symbol">/</span><span class="sh_keyword">private</span> rsa key pair<span class="sh_symbol">.</span></li><li>Enter file <span class="sh_keyword">in</span> which to save the <span class="sh_function">key</span> <span class="sh_symbol">(</span><span class="sh_regexp">/root/</span><span class="sh_symbol">.</span><span class="sh_normal">ssh</span><span class="sh_symbol">/</span>id_rsa<span class="sh_symbol">):</span></li><li>Created directory <span class="sh_string">'/root/.ssh'</span><span class="sh_symbol">.</span></li><li>Enter <span class="sh_function">passphrase</span> <span class="sh_symbol">(</span>empty <span class="sh_keyword">for</span> no passphrase<span class="sh_symbol">):</span>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//直接回车将口令设为空</span></li><li>Enter same passphrase again<span class="sh_symbol">:</span>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//再次回车确认</span></li><li>Your identification has been saved <span class="sh_keyword">in</span> <span class="sh_regexp">/root/</span><span class="sh_symbol">.</span><span class="sh_normal">ssh</span><span class="sh_symbol">/</span>id_rsa<span class="sh_symbol">.</span></li><li>Your <span class="sh_keyword">public</span> key has been saved <span class="sh_keyword">in</span> <span class="sh_regexp">/root/</span><span class="sh_symbol">.</span><span class="sh_normal">ssh</span><span class="sh_symbol">/</span>id_rsa<span class="sh_symbol">.</span>pub<span class="sh_symbol">.</span></li><li>The key fingerprint is<span class="sh_symbol">:</span></li><li><span class="sh_number">63</span><span class="sh_symbol">:</span>6e<span class="sh_symbol">:</span>cf<span class="sh_symbol">:</span><span class="sh_number">45</span><span class="sh_symbol">:</span>f0<span class="sh_symbol">:</span><span class="sh_number">56</span><span class="sh_symbol">:</span>e2<span class="sh_symbol">:</span><span class="sh_number">89</span><span class="sh_symbol">:</span>6f<span class="sh_symbol">:</span><span class="sh_number">62</span><span class="sh_symbol">:</span><span class="sh_number">64</span><span class="sh_symbol">:</span>5a<span class="sh_symbol">:</span>5e<span class="sh_symbol">:</span>fd<span class="sh_symbol">:</span><span class="sh_number">68</span><span class="sh_symbol">:</span>d2</li><li>The key<span class="sh_string">'s randomart image is:</span></li><li><span class="sh_string">+--[ RSA 2048]----+</span></li><li><span class="sh_string">|                 |</span></li><li><span class="sh_string">|                 |</span></li><li><span class="sh_string">|          . . .  |</span></li><li><span class="sh_string">|           = =   |</span></li><li><span class="sh_string">|        S = B .  |</span></li><li><span class="sh_string">|       o B = . o |</span></li><li><span class="sh_string">|        + + = E .|</span></li><li><span class="sh_string">|       . + + o   |</span></li><li><span class="sh_string">|          o      |</span></li><li><span class="sh_string">+-----------------+</span></li><li><span class="sh_string">[root@client ~]$ ls -lh ~/.ssh/id_rsa*  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//确认密钥对文件</span></li><li><span class="sh_string">-rw-------. 1 root root 1.8K 8月  15 10:35 /root/.ssh/id_rsa</span></li><li><span class="sh_string">-rw-r--r--. 1 root root  403 8月  15 10:35 /root/.ssh/id_rsa.pub</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@client ~]$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa):
Created directory '/root/.ssh'.
Enter passphrase (empty for no passphrase):  			//直接回车将口令设为空
Enter same passphrase again:  							//再次回车确认
Your identification has been saved in /root/.ssh/id_rsa.
Your public key has been saved in /root/.ssh/id_rsa.pub.
The key fingerprint is:
63:6e:cf:45:f0:56:e2:89:6f:62:64:5a:5e:fd:68:d2
The key's randomart image is:
+--[ RSA 2048]----+
|                 |
|                 |
|          . . .  |
|           = =   |
|        S = B .  |
|       o B = . o |
|        + + = E .|
|       . + + o   |
|          o      |
+-----------------+
[root@client ~]$ ls -lh ~/.ssh/id_rsa*  				//确认密钥对文件
-rw-------. 1 root root 1.8K 8月  15 10:35 /root/.ssh/id_rsa
-rw-r--r--. 1 root root  403 8月  15 10:35 /root/.ssh/id_rsa.pub
</pre></div></div>
      <p>2）将客户机上用户root的公钥部署到SSH服务器</p>
      <p>以用户root登入客户机，使用ssh-copy-id命令将自己的公钥部署到服务器：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span>$ ssh<span class="sh_symbol">-</span>copy<span class="sh_symbol">-</span>id root@<span class="sh_number">192.168.4.5</span></li><li>root@<span class="sh_number">192.168.4.5</span><span class="sh_string">'s password:</span></li><li><span class="sh_string">Now try logging into the machine, with "ssh '</span>root@<span class="sh_number">192.168.4.5</span><span class="sh_string">'", and check in:</span></li><li><span class="sh_string">  .ssh/authorized_keys</span></li><li><span class="sh_string">to make sure we haven'</span>t added extra keys that you weren<span class="sh_string">'t expecting.</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@client ~]$ ssh-copy-id root@192.168.4.5
root@192.168.4.5's password:
Now try logging into the machine, with "ssh 'root@192.168.4.5'", and check in:
  .ssh/authorized_keys
to make sure we haven't added extra keys that you weren't expecting.
</pre></div></div>
      <p>3）在服务器上确认客户机用户root上传的公钥信息</p>
      <p>默认部署位置为目标用户的家目录下 ~/.ssh/authorized_keys文件：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># tail <span class="sh_symbol">-</span><span class="sh_number">2</span> <span class="sh_symbol">~</span><span class="sh_regexp">/.ssh/</span>authorized_keys</li><li>ssh<span class="sh_symbol">-</span>rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAzz<span class="sh_symbol">+</span>5AiFMGQ7LfuiV7eBnOcmRO9JRTcqRoynGO2y5</li><li>RyFL<span class="sh_symbol">+</span>LxR1IpEbkNrUyIZDk5uaX1Y8rwsf<span class="sh_symbol">+</span><span class="sh_normal">pa7UZ2NyqmUEvNSUo0hQyDGsU9SPyAdzRCCvDgwpOFhaHi</span><span class="sh_symbol">/</span>OFnT<span class="sh_symbol">+</span><span class="sh_normal">zqjAqXH2M9fFYEVUU4PIVL8HT19zCQRVZ</span><span class="sh_symbol">/</span>q3acQA34UsQUR0PpLJAobsf1BLe2EDM8BsSHckDGsNoDT9vk<span class="sh_symbol">+</span><span class="sh_normal">u3e83RaehBMuy1cVEN5sLAaIrIeyM8Q0WxQNlqknL908HRkTlTeKrRoHbMnOBFj8StwlnscKHlkrsKkhUf8A9WWz</span><span class="sh_symbol">/</span>vL4GDwGND5jdca3I2hdITAySjMdfL1HMHnMYOgMjPM0Q<span class="sh_symbol">==</span> root@<span class="sh_number">192.168.4.100</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# tail -2 ~/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAzz+5AiFMGQ7LfuiV7eBnOcmRO9JRTcqRoynGO2y5
RyFL+LxR1IpEbkNrUyIZDk5uaX1Y8rwsf+pa7UZ2NyqmUEvNSUo0hQyDGsU9SPyAdzRCCvDgwpOFhaHi/OFnT+zqjAqXH2M9fFYEVUU4PIVL8HT19zCQRVZ/q3acQA34UsQUR0PpLJAobsf1BLe2EDM8BsSHckDGsNoDT9vk+u3e83RaehBMuy1cVEN5sLAaIrIeyM8Q0WxQNlqknL908HRkTlTeKrRoHbMnOBFj8StwlnscKHlkrsKkhUf8A9WWz/vL4GDwGND5jdca3I2hdITAySjMdfL1HMHnMYOgMjPM0Q== root@192.168.4.100
</pre></div></div>
      <p>4）在客户机上测试SSH密钥对验证</p>
      <p>在客户机用户root的环境中，以远程用户root登入192.168.4.5主机时，无需验证口令即可登入（因为私钥口令为空）：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@client <span class="sh_symbol">~]</span>$ ssh root@<span class="sh_number">192.168.4.5</span>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//免交互直接登入</span></li><li>Last login<span class="sh_symbol">:</span> Thu Aug <span class="sh_number">15</span> <span class="sh_number">10</span><span class="sh_symbol">:</span><span class="sh_number">48</span><span class="sh_symbol">:</span><span class="sh_number">09</span> <span class="sh_number">2013</span> from <span class="sh_number">192.168.4.100</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@client ~]$ ssh root@192.168.4.5  					//免交互直接登入
Last login: Thu Aug 15 10:48:09 2013 from 192.168.4.100
</pre></div></div>
      <p class="number">步骤四：确认密钥验证使用正常后，禁用口令验证</p>
      <p>1）调整sshd服务配置，将PasswordAuthentication设为no</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span><span class="sh_normal">ssh</span><span class="sh_symbol">/</span>sshd_config</li><li><span class="sh_symbol">..</span> <span class="sh_symbol">..</span></li><li>PasswordAuthentication no  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//将此行yes改成no</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># systemctl restart sshd</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# vim /etc/ssh/sshd_config
.. ..
PasswordAuthentication no  							//将此行yes改成no

[root@proxy ~]# systemctl restart sshd
</pre></div></div>
      <a name="case4">
      </a>
      <h2>4 案例4：SELinux安全防护</h2>
      <h3>4.1 问题</h3>
      <p>本案例要求熟悉SELinux防护机制的开关及策略配置，完成以下任务：</p>
      <ol class="list">
        <li>将Linux服务器的SELinux设为enforcing强制模式
</li>
        <li>从/root目录下移动一个包文件到FTP下载目录，调整策略使其能够被下载
</li>
      </ol>
      <h3>4.2 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一：将Linux服务器的SELinux设为enforcing强制模式</p>
      <p>1）固定配置：修改/etc/selinux/config文件</p>
      <p>确认或修改SELINUX为enforcing模式：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span><span class="sh_normal">selinux</span><span class="sh_symbol">/</span>config</li><li>SELINUX<span class="sh_symbol">=</span>enforcing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//设置SELinux为强制模式</span></li><li>SELINUXTYPE<span class="sh_symbol">=</span>targeted&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//保护策略为保护主要的网络服务安全</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# vim /etc/selinux/config
SELINUX=enforcing								//设置SELinux为强制模式
SELINUXTYPE=targeted							//保护策略为保护主要的网络服务安全
</pre></div></div>
      <p>2）临时配置：使用setenforce命令</p>
      <p>查看当前SELinux状态，如果是disabled则需要根据第1）步的配置重启系统；如果是permissive则使用setenforce命令修改为enforcing即可：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># getenforce&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//查看当前状态为警告模式</span></li><li>Permissive</li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># setenforce <span class="sh_number">1</span>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//设置SELinux为强制模式</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># getenforce&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//查看当前模式为强制模式</span></li><li>Enforcing</li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># setenforce <span class="sh_number">0</span>  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//设置SELinux为强制模式</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># getenforce&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//查看当前模式为警告模式</span></li><li>Permissive</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# getenforce						//查看当前状态为警告模式
Permissive
[root@proxy ~]# setenforce 1  					//设置SELinux为强制模式
[root@proxy ~]# getenforce						//查看当前模式为强制模式
Enforcing
[root@proxy ~]# setenforce 0  					//设置SELinux为强制模式
[root@proxy ~]# getenforce						//查看当前模式为警告模式
Permissive
</pre></div></div>
      <p class="number">步骤二：在SELinux启用状态下，调整策略打开vsftpd服务的匿名上传访问</p>
      <p>1）配置一个允许匿名上传的vsftpd服务作为测试环境</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># setenforce <span class="sh_number">1</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># yum <span class="sh_symbol">-</span>y install vsftpd</li><li><span class="sh_symbol">..</span> <span class="sh_symbol">..</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span><span class="sh_normal">vsftpd</span><span class="sh_symbol">/</span>vsftpd<span class="sh_symbol">.</span>conf</li><li>anonymous_enable<span class="sh_symbol">=</span>YES  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//开启匿名访问</span></li><li>anon_upload_enable<span class="sh_symbol">=</span>YES  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//允许上传文件</span></li><li>anon_mkdir_write_enable<span class="sh_symbol">=</span>YES  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//允许上传目录</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># systemctl start vsftpd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//启动服务</span></li><li><span class="sh_comment">//默认Vsftpd共享目录为/var/ftp/</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# setenforce 1
[root@proxy ~]# yum -y install vsftpd
.. ..
[root@proxy ~]# vim /etc/vsftpd/vsftpd.conf
anonymous_enable=YES  								//开启匿名访问
anon_upload_enable=YES  							//允许上传文件
anon_mkdir_write_enable=YES  						//允许上传目录
[root@proxy ~]# systemctl start vsftpd				//启动服务
//默认Vsftpd共享目录为/var/ftp/
</pre></div></div>
      <p class="number">步骤三：从/root目录下移动2个包文件到FTP下载目录，调整文件的安全上下文</p>
      <p>1）建立两个FTP下载用的测试文件</p>
      <p>由root用户创建两个测试压缩包，一个直接建立到/var/ftp/目录下，另一个先在/root/下建立，然后移动至/var/ftp/目录。</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_comment">//测试文件1，直接在ftp目录下创建文件</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># tar <span class="sh_symbol">-</span><span class="sh_normal">czf  </span><span class="sh_symbol">/</span><span class="sh_keyword">var</span><span class="sh_regexp">/ftp/</span>log1<span class="sh_symbol">.</span><span class="sh_normal">tar  </span><span class="sh_symbol">/</span><span class="sh_keyword">var</span><span class="sh_symbol">/</span>log</li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># ls <span class="sh_symbol">-</span><span class="sh_normal">lh </span><span class="sh_symbol">/</span><span class="sh_keyword">var</span><span class="sh_regexp">/ftp/</span></li><li><span class="sh_symbol">-</span>rw<span class="sh_symbol">-</span>r<span class="sh_symbol">--</span>r<span class="sh_symbol">--.</span> <span class="sh_number">1</span> root root 8M <span class="sh_number">8</span>月  <span class="sh_number">16</span> <span class="sh_number">10</span><span class="sh_symbol">:</span><span class="sh_number">16</span> log1<span class="sh_symbol">.</span>tar</li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># ls <span class="sh_symbol">-</span><span class="sh_normal">Z </span><span class="sh_symbol">/</span><span class="sh_keyword">var</span><span class="sh_regexp">/ftp/</span></li><li><span class="sh_symbol">-</span>rw<span class="sh_symbol">-</span>r<span class="sh_symbol">--</span>r<span class="sh_symbol">--.</span> root root unconfined_u<span class="sh_symbol">:</span>object_r<span class="sh_symbol">:</span>public_content_t<span class="sh_symbol">:</span>s0 log1<span class="sh_symbol">.</span>tar</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_comment">//测试文件2，在/root下建立，然后移动至/var/ftp目录</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># tar <span class="sh_symbol">-</span>czf  log2<span class="sh_symbol">.</span><span class="sh_normal">tar  </span><span class="sh_symbol">/</span><span class="sh_keyword">var</span><span class="sh_symbol">/</span>log</li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># mv log2<span class="sh_symbol">.</span><span class="sh_normal">tar </span><span class="sh_symbol">/</span><span class="sh_keyword">var</span><span class="sh_regexp">/ftp/</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># ls <span class="sh_symbol">-</span><span class="sh_normal">lh </span><span class="sh_symbol">/</span><span class="sh_keyword">var</span><span class="sh_regexp">/ftp/</span></li><li><span class="sh_symbol">-</span>rw<span class="sh_symbol">-</span>r<span class="sh_symbol">--</span>r<span class="sh_symbol">--.</span> <span class="sh_number">1</span> root root 8M <span class="sh_number">8</span>月  <span class="sh_number">16</span> <span class="sh_number">10</span><span class="sh_symbol">:</span><span class="sh_number">16</span> log2<span class="sh_symbol">.</span>tar</li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># ls <span class="sh_symbol">-</span><span class="sh_normal">Z </span><span class="sh_symbol">/</span><span class="sh_keyword">var</span><span class="sh_regexp">/ftp/</span></li><li><span class="sh_symbol">-</span>rw<span class="sh_symbol">-</span>r<span class="sh_symbol">--</span>r<span class="sh_symbol">--.</span> <span class="sh_number">1</span> root root unconfined_u<span class="sh_symbol">:</span>object_r<span class="sh_symbol">:</span>admin_home_t<span class="sh_symbol">:</span>s0 log2<span class="sh_symbol">.</span>tar</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">//测试文件1，直接在ftp目录下创建文件
[root@proxy ~]# tar -czf  /var/ftp/log1.tar  /var/log
[root@proxy ~]# ls -lh /var/ftp/
-rw-r--r--. 1 root root 8M 8月  16 10:16 log1.tar
[root@proxy ~]# ls -Z /var/ftp/
-rw-r--r--. root root unconfined_u:object_r:public_content_t:s0 log1.tar

//测试文件2，在/root下建立，然后移动至/var/ftp目录
[root@proxy ~]# tar -czf  log2.tar  /var/log
[root@proxy ~]# mv log2.tar /var/ftp/
[root@proxy ~]# ls -lh /var/ftp/
-rw-r--r--. 1 root root 8M 8月  16 10:16 log2.tar
[root@proxy ~]# ls -Z /var/ftp/
-rw-r--r--. 1 root root unconfined_u:object_r:admin_home_t:s0 log2.tar
</pre></div></div>
      <p>3）通过FTP方式测试下载</p>
      <p>使用wget命令分别下载这两个包文件，第二个包将会下载失败（看不到文件）。</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># wget ftp<span class="sh_symbol">:</span><span class="sh_comment">//192.168.4.5/log1.tar&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//下载第一个文件，成功</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># wget ftp<span class="sh_symbol">:</span><span class="sh_comment">//192.168.4.5/log2.tar&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//下载第二个文件，失败</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# wget ftp://192.168.4.5/log1.tar			//下载第一个文件，成功

[root@proxy ~]# wget ftp://192.168.4.5/log2.tar			//下载第二个文件，失败
</pre></div></div>
      <p>4）检查该测试包的安全上下文，正确调整后再次下载第二个包成功。</p>
      <p>文件已经存放到共享目录下，但客户端无法访问下载，是因为被SELinux拦截了！</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/SECURITY/DAY01/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># ls <span class="sh_symbol">-</span><span class="sh_normal">Z </span><span class="sh_symbol">/</span><span class="sh_keyword">var</span><span class="sh_regexp">/ftp/</span></li><li><span class="sh_symbol">-</span>rw<span class="sh_symbol">-</span>r<span class="sh_symbol">--</span>r<span class="sh_symbol">--.</span> root root unconfined_u<span class="sh_symbol">:</span>object_r<span class="sh_symbol">:</span>public_content_t<span class="sh_symbol">:</span>s0 log1<span class="sh_symbol">.</span>tar</li><li><span class="sh_symbol">-</span>rw<span class="sh_symbol">-</span>r<span class="sh_symbol">--</span>r<span class="sh_symbol">--.</span> <span class="sh_number">1</span> root root unconfined_u<span class="sh_symbol">:</span>object_r<span class="sh_symbol">:</span>admin_home_t<span class="sh_symbol">:</span>s0   log2<span class="sh_symbol">.</span>tar</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># chcon <span class="sh_symbol">-</span>t <span class="sh_normal">public_content_t </span><span class="sh_symbol">/</span><span class="sh_keyword">var</span><span class="sh_regexp">/ftp/</span>d2<span class="sh_symbol">.</span>tar<span class="sh_symbol">.</span>gz</li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># ls <span class="sh_symbol">-</span><span class="sh_normal">Z </span><span class="sh_symbol">/</span><span class="sh_keyword">var</span><span class="sh_regexp">/ftp/</span>log2<span class="sh_symbol">.</span>tar</li><li><span class="sh_symbol">-</span>rw<span class="sh_symbol">-</span>r<span class="sh_symbol">--</span>r<span class="sh_symbol">--.</span> root root unconfined_u<span class="sh_symbol">:</span>object_r<span class="sh_symbol">:</span>public_content_t<span class="sh_symbol">:</span>s0 log2<span class="sh_symbol">.</span>tar</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@proxy <span class="sh_symbol">~]</span># wget ftp<span class="sh_symbol">:</span><span class="sh_comment">//192.168.4.5/log2.tar&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//再次下载，成功</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@proxy ~]# ls -Z /var/ftp/
-rw-r--r--. root root unconfined_u:object_r:public_content_t:s0 log1.tar
-rw-r--r--. 1 root root unconfined_u:object_r:admin_home_t:s0   log2.tar

[root@proxy ~]# chcon -t public_content_t /var/ftp/d2.tar.gz
[root@proxy ~]# ls -Z /var/ftp/log2.tar
-rw-r--r--. root root unconfined_u:object_r:public_content_t:s0 log2.tar

[root@proxy ~]# wget ftp://192.168.4.5/log2.tar			//再次下载，成功
</pre></div></div>
      <p class="emphasiz">注意：上例中的chcon操作可替换为（效果相同）：</p>
      <p class="emphasiz"># restorecon /var/ftp/log2.tar.gz</p>
      <p class="emphasiz">或者</p>
      <p class="emphasiz"># chcon --reference=/var/ftp/log1.tar.gz /var/ftp/log2.tar.gz</p>
    </div>
  
</body></html>