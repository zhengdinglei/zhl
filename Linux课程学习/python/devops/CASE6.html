
<!-- saved from url=(0077)http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>CASE</title>
    
    <script type="text/javascript" src="./CASE6_files/jquery.min.js">
    </script>
    <script type="text/javascript" src="./CASE6_files/jquery.snippet.js">
    </script>
    <script type="text/javascript" src="./CASE6_files/main.js">
    </script>
    <link type="text/css" href="./CASE6_files/index.css" rel="Stylesheet">
    <link type="text/css" href="./CASE6_files/jquery.snippet.css" rel="Stylesheet">
  </head>
  <body>
    <div class="source_style_case">
      <a name="page_top_case" id="top_anchor">
      </a><a id="link_top" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#page_top_case">Top</a>
      <h1>NSD Devops DAY06</h1>
      <ol class="index">
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#case1">案例1：准备ansible环境</a>
        </li>
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#case2">案例2：使用playbook</a>
        </li>
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#case3">案例3：执行ad-hoc命令</a>
        </li>
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#case4">案例4：playbook编程</a>
        </li>
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#case5">案例5：ansible模块开发</a>
        </li>
      </ol>
      <a name="case1">
      </a>
      <h2>1 案例1：准备ansible环境</h2>
      <h3>1.1 问题</h3>
      <ol class="list">
        <li>创建ansible工作目录
</li>
        <li>创建配置文件及主机列表文件
</li>
        <li>测试在远程主机执行命令
</li>
      </ol>
      <h3>1.2 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一： 安装ansible</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost <span class="sh_symbol">~]</span># yum install <span class="sh_symbol">-</span>y ansible</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost ~]# yum install -y ansible
</pre></div></div>
      <p class="number">步骤二： 创建ansible工作目录</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost <span class="sh_symbol">~]</span># <span class="sh_normal">mkdir </span><span class="sh_symbol">/</span><span class="sh_normal">root</span><span class="sh_symbol">/</span><span class="sh_normal">myansi</span><span class="sh_symbol">/</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost ~]# mkdir /root/myansi/
</pre></div></div>
      <p class="number">步骤三：创建配置文件</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost <span class="sh_symbol">~]</span># <span class="sh_normal">cd </span><span class="sh_symbol">/</span><span class="sh_normal">root</span><span class="sh_symbol">/</span><span class="sh_normal">myansi</span><span class="sh_symbol">/</span>&nbsp;&nbsp;&nbsp;&nbsp;</li><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># cat ansible<span class="sh_symbol">.</span>cfg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li><li><span class="sh_symbol">[</span>defaults<span class="sh_symbol">]</span>&nbsp;&nbsp;&nbsp;&nbsp;</li><li>inventory&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">=</span>hosts&nbsp;&nbsp;&nbsp;&nbsp;</li><li>remote_user<span class="sh_symbol">=</span>root</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost ~]# cd /root/myansi/	
[root@localhost myansi]# cat ansible.cfg		
[defaults]	
inventory	=hosts	
remote_user=root
</pre></div></div>
      <p class="number">步骤四：创建声明被管理主机</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># vim hosts&nbsp;&nbsp;&nbsp;&nbsp;</li><li><span class="sh_symbol">[</span>dbservers<span class="sh_symbol">]</span></li><li>node1<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>webservers<span class="sh_symbol">]</span></li><li>node2<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn</li><li>node3<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn </li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost myansi]# vim hosts	
[dbservers]
node1.tedu.cn

[webservers]
node2.tedu.cn
node3.tedu.cn 
</pre></div></div>
      <p class="number">步骤四：配置名称解析</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>hosts</li><li><span class="sh_number">192.168.4.1</span> node1<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn node1</li><li><span class="sh_number">192.168.4.2</span> node2<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn node2</li><li><span class="sh_number">192.168.4.3</span> node3<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn node3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost myansi]# vim /etc/hosts
192.168.4.1 node1.tedu.cn node1
192.168.4.2 node2.tedu.cn node2
192.168.4.3 node3.tedu.cn node3		
</pre></div></div>
      <p class="number">步骤五：导入所有服务器的主机公钥</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># ssh<span class="sh_symbol">-</span>keyscan <span class="sh_number">192.168.4</span><span class="sh_symbol">.</span><span class="sh_cbracket">{</span><span class="sh_number">1</span><span class="sh_symbol">..</span><span class="sh_number">3</span><span class="sh_cbracket">}</span> node<span class="sh_cbracket">{</span><span class="sh_number">1</span><span class="sh_symbol">..</span><span class="sh_number">3</span><span class="sh_cbracket">}</span> node<span class="sh_cbracket">{</span><span class="sh_number">1</span><span class="sh_symbol">..</span><span class="sh_number">3</span><span class="sh_cbracket">}</span><span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn <span class="sh_symbol">&gt;&gt;</span> <span class="sh_symbol">~</span><span class="sh_regexp">/.ssh/</span>known_hosts</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost myansi]# ssh-keyscan 192.168.4.{1..3} node{1..3} node{1..3}.tedu.cn &gt;&gt; ~/.ssh/known_hosts
</pre></div></div>
      <p class="number">步骤六：测试ansible到各服务器的连接</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># ansible all <span class="sh_symbol">-</span>m ping –k</li><li>SSH password：</li><li>node1<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">|</span>&nbsp;&nbsp;&nbsp;&nbsp;SUCCESS&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">=&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_cbracket">{</span>&nbsp;&nbsp;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_string">"changed"</span><span class="sh_symbol">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_keyword">false</span><span class="sh_symbol">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_string">"ping"</span><span class="sh_symbol">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_string">"pong"</span>&nbsp;&nbsp;&nbsp;&nbsp;</li><li><span class="sh_cbracket">}</span>&nbsp;&nbsp;&nbsp;&nbsp;</li><li>node3<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">|</span>&nbsp;&nbsp;&nbsp;&nbsp;SUCCESS&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">=&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_cbracket">{</span>&nbsp;&nbsp;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_string">"changed"</span><span class="sh_symbol">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_keyword">false</span><span class="sh_symbol">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_string">"ping"</span><span class="sh_symbol">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_string">"pong"</span>&nbsp;&nbsp;&nbsp;&nbsp;</li><li><span class="sh_cbracket">}</span></li><li>node2<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">|</span>&nbsp;&nbsp;&nbsp;&nbsp;SUCCESS&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol">=&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_cbracket">{</span>&nbsp;&nbsp;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_string">"changed"</span><span class="sh_symbol">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_keyword">false</span><span class="sh_symbol">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_string">"ping"</span><span class="sh_symbol">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_string">"pong"</span>&nbsp;&nbsp;&nbsp;&nbsp;</li><li><span class="sh_cbracket">}</span>&nbsp;&nbsp;&nbsp;&nbsp;</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost myansi]# ansible all -m ping –k
SSH password：
node1.tedu.cn	|	SUCCESS	=&gt;	{	
				"changed":	false,		
				"ping":	"pong"	
}	
node3.tedu.cn	|	SUCCESS	=&gt;	{	
				"changed":	false,		
				"ping":	"pong"	
}
node2.tedu.cn	|	SUCCESS	=&gt;	{	
				"changed":	false,		
				"ping":	"pong"	
}	
</pre></div></div>
      <p class="number">步骤六：在远程主机执行命令</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># ansible node1<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn <span class="sh_symbol">-</span>m yum <span class="sh_symbol">-</span>a <span class="sh_string">'name=httpd state=present'</span> –k</li><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># ansible all <span class="sh_symbol">-</span>a <span class="sh_string">'id zhangsan'</span> <span class="sh_symbol">-</span>k</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost myansi]# ansible node1.tedu.cn -m yum -a 'name=httpd state=present' –k
[root@localhost myansi]# ansible all -a 'id zhangsan' -k
</pre></div></div>
      <a name="case2">
      </a>
      <h2>2 案例2：使用playbook</h2>
      <h3>2.1 问题</h3>
      <ol class="list">
        <li>Playbook有两个play
</li>
        <li>一个play用于在webservers安装并启动httpd服务
</li>
        <li>另一个play用于在dbservers安装并启动mariadb服务
</li>
      </ol>
      <h3>2.2 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一：实现免密登陆：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># vim auth_key<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">---</span></li><li><span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> configure authorized key</li><li>  hosts<span class="sh_symbol">:</span> all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#运行执行任务（task）的目标主机</li><li>  tasks<span class="sh_symbol">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#任务列表</li><li>  <span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> root key</li><li>    authorized_key<span class="sh_symbol">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#为root用户账号添加或删除 SSH authorized keys</li><li>      user<span class="sh_symbol">:</span> root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#用户</li><li>      state<span class="sh_symbol">:</span> present&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#状态</li><li>      key<span class="sh_symbol">:</span> <span class="sh_string">"{{ lookup('file', '/root/.ssh/id_rsa.pub') }}"</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost myansi]# vim auth_key.yml
---
- name: configure authorized key
  hosts: all		#运行执行任务（task）的目标主机
  tasks:			#任务列表
  - name: root key
    authorized_key:		#为root用户账号添加或删除 SSH authorized keys
      user: root			#用户
      state: present		#状态
      key: "{{ lookup('file', '/root/.ssh/id_rsa.pub') }}"

</pre></div></div>
      <p>验证脚本执行情况：</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook <span class="sh_symbol">--</span>syntax<span class="sh_symbol">-</span>check auth_key<span class="sh_symbol">.</span>yml&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#检查语法</li><li>#调用密码执行所有主机的免密登录</li><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook auth_key<span class="sh_symbol">.</span>yml –k&nbsp;&nbsp;&nbsp;&nbsp;</li><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># ansible all <span class="sh_symbol">-</span>m ping&nbsp;&nbsp;&nbsp;&nbsp;#查看所有主机连接情况</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost myansi]# ansible-playbook --syntax-check auth_key.yml		#检查语法
#调用密码执行所有主机的免密登录
[root@localhost myansi]# ansible-playbook auth_key.yml –k	
[root@localhost myansi]# ansible all -m ping	#查看所有主机连接情况
</pre></div></div>
      <p class="number">步骤二：配置yum</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># mkdir files</li><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># <span class="sh_normal">cp </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>yum<span class="sh_symbol">.</span>repos<span class="sh_symbol">.</span><span class="sh_normal">d</span><span class="sh_symbol">/</span>server<span class="sh_symbol">.</span>repo <span class="sh_normal">files</span><span class="sh_symbol">/</span></li><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># vim auth_key<span class="sh_symbol">.</span>yml&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#在文件末尾追加</li><li>&nbsp;&nbsp;&nbsp;&nbsp;  <span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> copy yum config file</li><li>    copy<span class="sh_symbol">:</span></li><li>      src<span class="sh_symbol">:</span> <span class="sh_normal">files</span><span class="sh_symbol">/</span>server<span class="sh_symbol">.</span>repo  # 本机目录</li><li>      dest<span class="sh_symbol">:</span> <span class="sh_regexp">/etc/</span>yum<span class="sh_symbol">.</span>repos<span class="sh_symbol">.</span><span class="sh_normal">d</span><span class="sh_symbol">/</span>  # 远程目录</li><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook auth_key<span class="sh_symbol">.</span>yml&nbsp;&nbsp;&nbsp;&nbsp;#执行脚本</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost myansi]# mkdir files
[root@localhost myansi]# cp /etc/yum.repos.d/server.repo files/
[root@localhost myansi]# vim auth_key.yml		#在文件末尾追加
	  - name: copy yum config file
    copy:
      src: files/server.repo  # 本机目录
      dest: /etc/yum.repos.d/  # 远程目录
[root@localhost myansi]# ansible-playbook auth_key.yml	#执行脚本
</pre></div></div>
      <p class="number">步骤三：配置服务</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># vim lamp<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">---</span></li><li>#在web服务器上配置httpd</li><li><span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> configure web service</li><li>  hosts<span class="sh_symbol">:</span> webservers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#hosts文件中node2、node3主机</li><li>#两个任务，yum安装httpd、php、php<span class="sh_symbol">-</span>mysql，启服务httpd</li><li>  tasks<span class="sh_symbol">:</span></li><li>    <span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> install web app</li><li>      yum<span class="sh_symbol">:</span></li><li>        name<span class="sh_symbol">:</span> <span class="sh_string">"{{item}}"</span></li><li>        state<span class="sh_symbol">:</span> present</li><li>      with_items<span class="sh_symbol">:</span></li><li>        <span class="sh_symbol">-</span> httpd</li><li>        <span class="sh_symbol">-</span> php</li><li>        <span class="sh_symbol">-</span> php<span class="sh_symbol">-</span>mysql</li><li>    <span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> config web service</li><li>      service<span class="sh_symbol">:</span></li><li>        name<span class="sh_symbol">:</span> httpd</li><li>        state<span class="sh_symbol">:</span> started</li><li>        enabled<span class="sh_symbol">:</span> <span class="sh_keyword">true</span></li><li><span style="display:none;">&nbsp;</span></li><li>#在数据库服务器上配置mariadb</li><li><span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> configure db service</li><li>  hosts<span class="sh_symbol">:</span> dbservers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#hosts文件中node1主机</li><li>#两个任务，yum安装mariadb<span class="sh_symbol">-</span>server，启服务mariadb</li><li> tasks<span class="sh_symbol">:</span></li><li>    <span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> install db app</li><li>      yum<span class="sh_symbol">:</span></li><li>        name<span class="sh_symbol">:</span> mariadb<span class="sh_symbol">-</span>server</li><li>        state<span class="sh_symbol">:</span> latest</li><li>    <span class="sh_symbol">-</span> name<span class="sh_symbol">:</span> config db serivce</li><li>      service<span class="sh_symbol">:</span></li><li>        name<span class="sh_symbol">:</span> mariadb</li><li>        state<span class="sh_symbol">:</span> started</li><li>        enabled<span class="sh_symbol">:</span> yes</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost myansi]# vim lamp.yml
---
#在web服务器上配置httpd
- name: configure web service
  hosts: webservers		#hosts文件中node2、node3主机
#两个任务，yum安装httpd、php、php-mysql，启服务httpd
  tasks:
    - name: install web app
      yum:
        name: "{{item}}"
        state: present
      with_items:
        - httpd
        - php
        - php-mysql
    - name: config web service
      service:
        name: httpd
        state: started
        enabled: true

#在数据库服务器上配置mariadb
- name: configure db service
  hosts: dbservers		#hosts文件中node1主机
#两个任务，yum安装mariadb-server，启服务mariadb
 tasks:
    - name: install db app
      yum:
        name: mariadb-server
        state: latest
    - name: config db serivce
      service:
        name: mariadb
        state: started
        enabled: yes
</pre></div></div>
      <p class="number">步骤四：测试脚本执行情况</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># ansible<span class="sh_symbol">-</span>playbook lamp<span class="sh_symbol">.</span>yml</li><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># ssh node2</li><li>Last login<span class="sh_symbol">:</span> Fri<span class="sh_symbol">......</span></li><li><span class="sh_symbol">[</span>root@node2 <span class="sh_symbol">~]</span># rpm –q php</li><li>php<span class="sh_number">-5.4.16-42</span><span class="sh_symbol">.</span>el7<span class="sh_symbol">.</span>x86_64</li><li><span class="sh_symbol">[</span>root@node2 <span class="sh_symbol">~]</span># rpm –q httpd</li><li>httpd<span class="sh_number">-2.4.6-67</span><span class="sh_symbol">.</span>el7<span class="sh_symbol">.</span>centos<span class="sh_symbol">.</span>x86_64</li><li><span class="sh_symbol">[</span>root@node2 <span class="sh_symbol">~]</span># systemctl status httpd</li><li><span class="sh_symbol">....</span></li><li>Active<span class="sh_symbol">:</span> <span class="sh_function">active</span><span class="sh_symbol">(</span>running<span class="sh_symbol">)......</span></li><li><span class="sh_symbol">.....</span></li><li><span class="sh_symbol">[</span>root@node2 <span class="sh_symbol">~]</span># 登出</li><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># ssh node1</li><li>Last login<span class="sh_symbol">:</span> Fri Aug <span class="sh_number">31</span> <span class="sh_number">11</span><span class="sh_symbol">:</span><span class="sh_number">52</span><span class="sh_symbol">:</span><span class="sh_number">44</span> <span class="sh_number">2018</span> from <span class="sh_number">192.168.4.254</span></li><li><span class="sh_symbol">[</span>root@node1 <span class="sh_symbol">~]</span>#systemctl status mariadb</li><li><span class="sh_symbol">....</span></li><li>Active<span class="sh_symbol">:</span> <span class="sh_function">active</span><span class="sh_symbol">(</span>running<span class="sh_symbol">)......</span></li><li><span class="sh_symbol">.....</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost myansi]# ansible-playbook lamp.yml
[root@localhost myansi]# ssh node2
Last login: Fri......
[root@node2 ~]# rpm –q php
php-5.4.16-42.el7.x86_64
[root@node2 ~]# rpm –q httpd
httpd-2.4.6-67.el7.centos.x86_64
[root@node2 ~]# systemctl status httpd
....
Active: active(running)......
.....
[root@node2 ~]# 登出
[root@localhost myansi]# ssh node1
Last login: Fri Aug 31 11:52:44 2018 from 192.168.4.254
[root@node1 ~]#systemctl status mariadb
....
Active: active(running)......
.....
</pre></div></div>
      <a name="case3">
      </a>
      <h2>3 案例3：执行ad-hoc命令</h2>
      <h3>3.1 问题</h3>
      <ol class="list">
        <li>编写ansible脚本
</li>
        <li>用于在远程主机执行任意命令
</li>
      </ol>
      <h3>3.2 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一：编写脚本</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost <span class="sh_symbol">~]</span># vim ansible_adhoc<span class="sh_symbol">.</span>py</li><li><span style="display:none;">&nbsp;</span></li><li>#<span class="sh_symbol">!</span><span class="sh_regexp">/usr/</span><span class="sh_normal">bin</span><span class="sh_symbol">/</span>env python</li><li># coding<span class="sh_symbol">:</span> utf8</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost ~]# vim ansible_adhoc.py

#!/usr/bin/env python
# coding: utf8
</pre></div></div>
      <p>导入模块</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li>import shutil</li><li>from collections import namedtuple</li><li># DataLoader用于解析<span class="sh_normal">yaml</span><span class="sh_symbol">/</span><span class="sh_normal">json</span><span class="sh_symbol">/</span>ini文件</li><li>from ansible<span class="sh_symbol">.</span>parsing<span class="sh_symbol">.</span>dataloader import DataLoader</li><li># VariableManager用于分析ansible用到的变量</li><li>from ansible<span class="sh_symbol">.</span>vars<span class="sh_symbol">.</span>manager import VariableManager</li><li># InventoryManager用于分析主机文件</li><li>from ansible<span class="sh_symbol">.</span>inventory<span class="sh_symbol">.</span>manager import InventoryManager</li><li>from ansible<span class="sh_symbol">.</span>playbook<span class="sh_symbol">.</span>play import Play</li><li># task_queue_manager管理任务队列</li><li>from ansible<span class="sh_symbol">.</span>executor<span class="sh_symbol">.</span>task_queue_manager import TaskQueueManager</li><li>import ansible<span class="sh_symbol">.</span>constants as C  # ansible的常量（不会变化的数据）</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">import shutil
from collections import namedtuple
# DataLoader用于解析yaml/json/ini文件
from ansible.parsing.dataloader import DataLoader
# VariableManager用于分析ansible用到的变量
from ansible.vars.manager import VariableManager
# InventoryManager用于分析主机文件
from ansible.inventory.manager import InventoryManager
from ansible.playbook.play import Play
# task_queue_manager管理任务队列
from ansible.executor.task_queue_manager import TaskQueueManager
import ansible.constants as C  # ansible的常量（不会变化的数据）
</pre></div></div>
      <p>设置参数</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li>#创建元组，将选项加入，如：connection：连接，module_path：模块路径，forks：进程数量等</li><li> Options <span class="sh_symbol">=</span> <span class="sh_function">namedtuple</span><span class="sh_symbol">(</span><span class="sh_string">'Options'</span><span class="sh_symbol">,</span> <span class="sh_symbol">[</span><span class="sh_string">'connection'</span><span class="sh_symbol">,</span> <span class="sh_string">'module_path'</span><span class="sh_symbol">,</span> <span class="sh_string">'forks'</span><span class="sh_symbol">,</span> <span class="sh_string">'become'</span><span class="sh_symbol">,</span> <span class="sh_string">'become_method'</span><span class="sh_symbol">,</span> <span class="sh_string">'become_user'</span><span class="sh_symbol">,</span> <span class="sh_string">'check'</span><span class="sh_symbol">,</span> <span class="sh_string">'diff'</span><span class="sh_symbol">])</span></li><li># 创建具体的实例对象</li><li># connection有三个选择<span class="sh_normal">local</span><span class="sh_symbol">/</span><span class="sh_normal">ssh</span><span class="sh_symbol">/</span>smart</li><li># local表示在本机执行，ssh表示通过ssh协议执行，smart表示自动选择</li><li>options <span class="sh_symbol">=</span> <span class="sh_function">Options</span><span class="sh_symbol">(</span>connection<span class="sh_symbol">=</span><span class="sh_string">'smart'</span><span class="sh_symbol">,</span> module_path<span class="sh_symbol">=[</span><span class="sh_string">'/to/mymodules'</span><span class="sh_symbol">],</span> forks<span class="sh_symbol">=</span><span class="sh_number">10</span><span class="sh_symbol">,</span> become<span class="sh_symbol">=</span>None<span class="sh_symbol">,</span> become_method<span class="sh_symbol">=</span>None<span class="sh_symbol">,</span> become_user<span class="sh_symbol">=</span>None<span class="sh_symbol">,</span> check<span class="sh_symbol">=</span>False<span class="sh_symbol">,</span> diff<span class="sh_symbol">=</span>False<span class="sh_symbol">)</span></li><li>loader <span class="sh_symbol">=</span> <span class="sh_function">DataLoader</span><span class="sh_symbol">()</span>  #负责查找和读取YAML、JSON和INI文件</li><li>passwords <span class="sh_symbol">=</span> <span class="sh_function">dict</span><span class="sh_symbol">()</span>  # 用于存储加密密码、远程连接密码等</li><li># 声明被ansible管理的主机有哪些，可以把各主机用逗号分开形成字符串</li><li># 也可以使用主机清单文件路径，将路径放到列表中</li><li># inventory <span class="sh_symbol">=</span> <span class="sh_function">InventoryManager</span><span class="sh_symbol">(</span>loader<span class="sh_symbol">=</span>loader<span class="sh_symbol">,</span> sources<span class="sh_symbol">=</span><span class="sh_string">'localhost,'</span><span class="sh_symbol">)</span></li><li>inventory <span class="sh_symbol">=</span> <span class="sh_function">InventoryManager</span><span class="sh_symbol">(</span>loader<span class="sh_symbol">=</span>loader<span class="sh_symbol">,</span> sources<span class="sh_symbol">=[</span><span class="sh_string">'myansi/hosts'</span><span class="sh_symbol">])</span></li><li><span style="display:none;">&nbsp;</span></li><li>#变量管理器负责合并所有不同的源，从而为每个上下文提供变量的统一视图。</li><li>variable_manager <span class="sh_symbol">=</span> <span class="sh_function">VariableManager</span><span class="sh_symbol">(</span>loader<span class="sh_symbol">=</span>loader<span class="sh_symbol">,</span> inventory<span class="sh_symbol">=</span>inventory<span class="sh_symbol">)</span></li><li>#脚本执行时屏幕显示的结果结构及信息</li><li>play_source <span class="sh_symbol">=</span> <span class="sh_function">dict</span><span class="sh_symbol">(</span></li><li>        name<span class="sh_symbol">=</span><span class="sh_string">"Ansible Play"</span><span class="sh_symbol">,</span>  # Play名称</li><li>        # hosts<span class="sh_symbol">=</span><span class="sh_string">'localhost'</span><span class="sh_symbol">,</span>  # 在哪些主机上执行命令</li><li>        hosts<span class="sh_symbol">=</span><span class="sh_string">'webservers'</span><span class="sh_symbol">,</span>  # 在上面inventory定影的<span class="sh_normal">myansi</span><span class="sh_symbol">/</span>hosts中查找</li><li>        gather_facts<span class="sh_symbol">=</span><span class="sh_string">'no'</span><span class="sh_symbol">,</span>  # 不收集主机信息</li><li>        tasks<span class="sh_symbol">=[</span></li><li>            # 以下是执行的命令</li><li>            <span class="sh_function">dict</span><span class="sh_symbol">(</span>action<span class="sh_symbol">=</span><span class="sh_function">dict</span><span class="sh_symbol">(</span>module<span class="sh_symbol">=</span><span class="sh_string">'yum'</span><span class="sh_symbol">,</span> args<span class="sh_symbol">=</span><span class="sh_string">'name=httpd state=latest'</span><span class="sh_symbol">),</span> register<span class="sh_symbol">=</span><span class="sh_string">'shell_out'</span><span class="sh_symbol">),</span></li><li>            #<span class="sh_function">dict</span><span class="sh_symbol">(</span>action<span class="sh_symbol">=</span><span class="sh_function">dict</span><span class="sh_symbol">(</span>module<span class="sh_symbol">=</span><span class="sh_string">'debug'</span><span class="sh_symbol">,</span> args<span class="sh_symbol">=</span><span class="sh_function">dict</span><span class="sh_symbol">(</span>msg<span class="sh_symbol">=</span><span class="sh_string">'{{shell_out}}'</span><span class="sh_symbol">)))</span></li><li>         <span class="sh_symbol">]</span></li><li>    <span class="sh_symbol">)</span></li><li>#上面导入的对象，play_source执行的任务有哪些，变量到的分析</li><li>play <span class="sh_symbol">=</span> <span class="sh_function">Play</span><span class="sh_symbol">().</span><span class="sh_function">load</span><span class="sh_symbol">(</span>play_source<span class="sh_symbol">,</span> variable_manager<span class="sh_symbol">=</span>variable_manager<span class="sh_symbol">,</span> loader<span class="sh_symbol">=</span>loader<span class="sh_symbol">)</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">#创建元组，将选项加入，如：connection：连接，module_path：模块路径，forks：进程数量等
 Options = namedtuple('Options', ['connection', 'module_path', 'forks', 'become', 'become_method', 'become_user', 'check', 'diff'])
# 创建具体的实例对象
# connection有三个选择local/ssh/smart
# local表示在本机执行，ssh表示通过ssh协议执行，smart表示自动选择
options = Options(connection='smart', module_path=['/to/mymodules'], forks=10, become=None, become_method=None, become_user=None, check=False, diff=False)
loader = DataLoader()  #负责查找和读取YAML、JSON和INI文件
passwords = dict()  # 用于存储加密密码、远程连接密码等
# 声明被ansible管理的主机有哪些，可以把各主机用逗号分开形成字符串
# 也可以使用主机清单文件路径，将路径放到列表中
# inventory = InventoryManager(loader=loader, sources='localhost,')
inventory = InventoryManager(loader=loader, sources=['myansi/hosts'])

#变量管理器负责合并所有不同的源，从而为每个上下文提供变量的统一视图。
variable_manager = VariableManager(loader=loader, inventory=inventory)
#脚本执行时屏幕显示的结果结构及信息
play_source = dict(
        name="Ansible Play",  # Play名称
        # hosts='localhost',  # 在哪些主机上执行命令
        hosts='webservers',  # 在上面inventory定影的myansi/hosts中查找
        gather_facts='no',  # 不收集主机信息
        tasks=[
            # 以下是执行的命令
            dict(action=dict(module='yum', args='name=httpd state=latest'), register='shell_out'),
            #dict(action=dict(module='debug', args=dict(msg='{{shell_out}}')))
         ]
    )
#上面导入的对象，play_source执行的任务有哪些，变量到的分析
play = Play().load(play_source, variable_manager=variable_manager, loader=loader)
</pre></div></div>
      <p>创建实例并执行命令</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li>tqm <span class="sh_symbol">=</span> None</li><li><span class="sh_keyword">try</span><span class="sh_symbol">:</span></li><li>#tqm是taskQueueManager任务管理器生成的实例</li><li>    tqm <span class="sh_symbol">=</span> <span class="sh_function">TaskQueueManager</span><span class="sh_symbol">(</span></li><li>              inventory<span class="sh_symbol">=</span>inventory<span class="sh_symbol">,</span>&nbsp;&nbsp;&nbsp;&nbsp;#主机清单</li><li>              variable_manager<span class="sh_symbol">=</span>variable_manager<span class="sh_symbol">,</span>&nbsp;&nbsp;&nbsp;&nbsp;#参数管理</li><li>              loader<span class="sh_symbol">=</span>loader<span class="sh_symbol">,</span>&nbsp;&nbsp;&nbsp;&nbsp;#json等语法分析</li><li>              options<span class="sh_symbol">=</span>options<span class="sh_symbol">,</span>&nbsp;&nbsp;&nbsp;&nbsp;#选项</li><li>              passwords<span class="sh_symbol">=</span>passwords<span class="sh_symbol">,</span>&nbsp;&nbsp;&nbsp;&nbsp;#密码</li><li>          <span class="sh_symbol">)</span></li><li>    result <span class="sh_symbol">=</span> tqm<span class="sh_symbol">.</span><span class="sh_function">run</span><span class="sh_symbol">(</span>play<span class="sh_symbol">)</span> # tqm实例中的run方法开始执行play中的任务</li><li><span class="sh_keyword">finally</span><span class="sh_symbol">:</span></li><li>    <span class="sh_keyword">if</span> tqm is not None<span class="sh_symbol">:</span>&nbsp;&nbsp;&nbsp;&nbsp;#如果tqm不为none</li><li>        tqm<span class="sh_symbol">.</span><span class="sh_function">cleanup</span><span class="sh_symbol">()</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#清理</li><li>    shutil<span class="sh_symbol">.</span><span class="sh_function">rmtree</span><span class="sh_symbol">(</span>C<span class="sh_symbol">.</span>DEFAULT_LOCAL_TMP<span class="sh_symbol">,</span> True<span class="sh_symbol">)</span>   #删除ansible执行任务是生成的临时目录</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">tqm = None
try:
#tqm是taskQueueManager任务管理器生成的实例
    tqm = TaskQueueManager(
              inventory=inventory,	#主机清单
              variable_manager=variable_manager,	#参数管理
              loader=loader,	#json等语法分析
              options=options,	#选项
              passwords=passwords,	#密码
          )
    result = tqm.run(play) # tqm实例中的run方法开始执行play中的任务
finally:
    if tqm is not None:	#如果tqm不为none
        tqm.cleanup()		#清理
    shutil.rmtree(C.DEFAULT_LOCAL_TMP, True)   #删除ansible执行任务是生成的临时目录
</pre></div></div>
      <p class="number">步骤二：测试执行脚本</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost <span class="sh_symbol">~]</span># python ansible_adhoc<span class="sh_symbol">.</span>py</li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>Ansible Play<span class="sh_symbol">]******************************************************</span></li><li><span class="sh_symbol">********</span></li><li>TASK <span class="sh_symbol">[</span>yum<span class="sh_symbol">]***************************************************************</span></li><li><span class="sh_symbol">********</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>node2<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn<span class="sh_symbol">]</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>node3<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn<span class="sh_symbol">]</span></li><li>您在 <span class="sh_regexp">/var/</span><span class="sh_normal">spool</span><span class="sh_symbol">/</span><span class="sh_normal">mail</span><span class="sh_symbol">/</span>root 中有新邮件</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost ~]# python ansible_adhoc.py

PLAY [Ansible Play]******************************************************
********
TASK [yum]***************************************************************
********
ok: [node2.tedu.cn]
ok: [node3.tedu.cn]
您在 /var/spool/mail/root 中有新邮件
</pre></div></div>
      <a name="case4">
      </a>
      <h2>4 案例4：playbook编程</h2>
      <h3>4.1 问题</h3>
      <ol class="list">
        <li>编写python程序
</li>
        <li>利用该程序执行前面课程中的playbook
</li>
      </ol>
      <h3>4.2 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一：编写脚本</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost <span class="sh_symbol">~]</span># vim run_pb<span class="sh_symbol">.</span>py</li><li><span style="display:none;">&nbsp;</span></li><li>#<span class="sh_symbol">!</span><span class="sh_regexp">/usr/</span><span class="sh_normal">bin</span><span class="sh_symbol">/</span>env python</li><li># coding<span class="sh_symbol">:</span> utf8</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost ~]# vim run_pb.py

#!/usr/bin/env python
# coding: utf8
</pre></div></div>
      <p>导入模块</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li>from collections import namedtuple</li><li>from ansible<span class="sh_symbol">.</span>parsing<span class="sh_symbol">.</span>dataloader import DataLoader</li><li>from ansible<span class="sh_symbol">.</span>vars<span class="sh_symbol">.</span>manager import VariableManager</li><li>from ansible<span class="sh_symbol">.</span>inventory<span class="sh_symbol">.</span>manager import InventoryManager</li><li>from ansible<span class="sh_symbol">.</span>executor<span class="sh_symbol">.</span>playbook_executor import PlaybookExecutor</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">from collections import namedtuple
from ansible.parsing.dataloader import DataLoader
from ansible.vars.manager import VariableManager
from ansible.inventory.manager import InventoryManager
from ansible.executor.playbook_executor import PlaybookExecutor
</pre></div></div>
      <p>设置参数</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li># 初始化需要的对象</li><li>Options <span class="sh_symbol">=</span> <span class="sh_function">namedtuple</span><span class="sh_symbol">(</span></li><li>    <span class="sh_string">'Options'</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">[</span></li><li>        <span class="sh_string">'connection'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'remote_user'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'ask_sudo_pass'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'verbosity'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'ask_pass'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'module_path'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'forks'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'become'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'become_method'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'become_user'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'check'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'listhosts'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'listtasks'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'listtags'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'syntax'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'sudo_user'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'sudo'</span><span class="sh_symbol">,</span></li><li>        <span class="sh_string">'diff'</span></li><li>    <span class="sh_symbol">]</span></li><li><span class="sh_symbol">)</span></li><li># 初始化需要的对象</li><li>ops <span class="sh_symbol">=</span> <span class="sh_function">Options</span><span class="sh_symbol">(</span></li><li>    connection<span class="sh_symbol">=</span><span class="sh_string">'smart'</span><span class="sh_symbol">,</span></li><li>    remote_user<span class="sh_symbol">=</span>None<span class="sh_symbol">,</span></li><li>    ask_pass<span class="sh_symbol">=</span>None<span class="sh_symbol">,</span></li><li>    sudo_user<span class="sh_symbol">=</span>None<span class="sh_symbol">,</span></li><li>    forks<span class="sh_symbol">=</span><span class="sh_number">5</span><span class="sh_symbol">,</span></li><li>    sudo<span class="sh_symbol">=</span>None<span class="sh_symbol">,</span></li><li>    ask_sudo_pass<span class="sh_symbol">=</span>False<span class="sh_symbol">,</span></li><li>    verbosity<span class="sh_symbol">=</span><span class="sh_number">5</span><span class="sh_symbol">,</span></li><li>    module_path<span class="sh_symbol">=</span>None<span class="sh_symbol">,</span></li><li>    become<span class="sh_symbol">=</span>None<span class="sh_symbol">,</span></li><li>    become_method<span class="sh_symbol">=</span>None<span class="sh_symbol">,</span></li><li>    become_user<span class="sh_symbol">=</span>None<span class="sh_symbol">,</span></li><li>    check<span class="sh_symbol">=</span>False<span class="sh_symbol">,</span></li><li>    diff<span class="sh_symbol">=</span>False<span class="sh_symbol">,</span></li><li>    listhosts<span class="sh_symbol">=</span>None<span class="sh_symbol">,</span></li><li>    listtags<span class="sh_symbol">=</span>None<span class="sh_symbol">,</span></li><li>    listtasks<span class="sh_symbol">=</span>None<span class="sh_symbol">,</span></li><li>    syntax<span class="sh_symbol">=</span>None</li><li><span class="sh_symbol">)</span></li><li># 用来加载解析yaml文件或JSON内容<span class="sh_symbol">,</span>并且支持vault的解密</li><li>loader <span class="sh_symbol">=</span> <span class="sh_function">DataLoader</span><span class="sh_symbol">()</span></li><li># 设置密码<span class="sh_symbol">,</span>需要是dict类型</li><li>passwords <span class="sh_symbol">=</span> <span class="sh_function">dict</span><span class="sh_symbol">()</span></li><li># 根据inventory加载对应变量<span class="sh_symbol">,</span>此处参数可以有两种格式：hosts文件或ip列表</li><li>inventory <span class="sh_symbol">=</span> <span class="sh_function">InventoryManager</span><span class="sh_symbol">(</span></li><li>    loader<span class="sh_symbol">=</span>loader<span class="sh_symbol">,</span></li><li>    sources<span class="sh_symbol">=[</span><span class="sh_string">'myansi/hosts'</span><span class="sh_symbol">]</span></li><li><span class="sh_symbol">)</span></li><li># 管理变量的类，包括主机，组，扩展等变量</li><li>variable_manager <span class="sh_symbol">=</span> <span class="sh_function">VariableManager</span><span class="sh_symbol">(</span></li><li>    loader<span class="sh_symbol">=</span>loader<span class="sh_symbol">,</span></li><li>    inventory<span class="sh_symbol">=</span>inventory</li><li><span class="sh_symbol">)</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;"># 初始化需要的对象
Options = namedtuple(
    'Options',
    [
        'connection',
        'remote_user',
        'ask_sudo_pass',
        'verbosity',
        'ask_pass',
        'module_path',
        'forks',
        'become',
        'become_method',
        'become_user',
        'check',
        'listhosts',
        'listtasks',
        'listtags',
        'syntax',
        'sudo_user',
        'sudo',
        'diff'
    ]
)
# 初始化需要的对象
ops = Options(
    connection='smart',
    remote_user=None,
    ask_pass=None,
    sudo_user=None,
    forks=5,
    sudo=None,
    ask_sudo_pass=False,
    verbosity=5,
    module_path=None,
    become=None,
    become_method=None,
    become_user=None,
    check=False,
    diff=False,
    listhosts=None,
    listtags=None,
    listtasks=None,
    syntax=None
)
# 用来加载解析yaml文件或JSON内容,并且支持vault的解密
loader = DataLoader()
# 设置密码,需要是dict类型
passwords = dict()
# 根据inventory加载对应变量,此处参数可以有两种格式：hosts文件或ip列表
inventory = InventoryManager(
    loader=loader,
    sources=['myansi/hosts']
)
# 管理变量的类，包括主机，组，扩展等变量
variable_manager = VariableManager(
    loader=loader,
    inventory=inventory
)
</pre></div></div>
      <p>创建实例并执行lamp.yml文件完成tasks任务</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li>def <span class="sh_function">run_pb</span><span class="sh_symbol">(</span>pb_path<span class="sh_symbol">):</span></li><li># playbooks就填写yml文件</li><li>    playbook <span class="sh_symbol">=</span> <span class="sh_function">PlaybookExecutor</span><span class="sh_symbol">(</span></li><li>        playbooks<span class="sh_symbol">=</span>pb_path<span class="sh_symbol">,</span></li><li>        inventory<span class="sh_symbol">=</span>inventory<span class="sh_symbol">,</span></li><li>        variable_manager<span class="sh_symbol">=</span>variable_manager<span class="sh_symbol">,</span></li><li>        loader<span class="sh_symbol">=</span>loader<span class="sh_symbol">,</span></li><li>        options<span class="sh_symbol">=</span>ops<span class="sh_symbol">,</span></li><li>        passwords<span class="sh_symbol">=</span>passwords</li><li>    <span class="sh_symbol">)</span></li><li>#开始执行</li><li>    result <span class="sh_symbol">=</span> playbook<span class="sh_symbol">.</span><span class="sh_function">run</span><span class="sh_symbol">()</span></li><li>    <span class="sh_keyword">return</span> result</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_keyword">if</span> __name__ <span class="sh_symbol">==</span> <span class="sh_string">'__main__'</span><span class="sh_symbol">:</span></li><li>    <span class="sh_function">run_pb</span><span class="sh_symbol">(</span>pb_path<span class="sh_symbol">=[</span><span class="sh_string">'myansi/lamp.yml'</span><span class="sh_symbol">])</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">def run_pb(pb_path):
# playbooks就填写yml文件
    playbook = PlaybookExecutor(
        playbooks=pb_path,
        inventory=inventory,
        variable_manager=variable_manager,
        loader=loader,
        options=ops,
        passwords=passwords
    )
#开始执行
    result = playbook.run()
    return result

if __name__ == '__main__':
    run_pb(pb_path=['myansi/lamp.yml'])
</pre></div></div>
      <p class="number">步骤二：测试执行脚本</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost <span class="sh_symbol">~]</span># python ansible_adhoc<span class="sh_symbol">.</span>py</li><li><span style="display:none;">&nbsp;</span></li><li>PLAY <span class="sh_symbol">[</span>configure web service<span class="sh_symbol">]***********************************************</span></li><li><span class="sh_symbol">*******</span></li><li>TASK <span class="sh_symbol">[</span>Gathering Facts<span class="sh_symbol">]*****************************************************</span></li><li><span class="sh_symbol">*******</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>node2<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn<span class="sh_symbol">]</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>node3<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn<span class="sh_symbol">]</span></li><li>TASK <span class="sh_symbol">[</span>install web app<span class="sh_symbol">]*****************************************************</span></li><li><span class="sh_symbol">*******</span></li><li>ok<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>node3<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn<span class="sh_symbol">]</span> <span class="sh_symbol">=&gt;</span> <span class="sh_symbol">(</span>item<span class="sh_symbol">=[</span>u‘httpd’， u‘php’， u‘php<span class="sh_symbol">-</span>mysql</li><li>’<span class="sh_symbol">])</span></li><li><span class="sh_symbol">.........</span></li><li><span class="sh_symbol">.........</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost ~]# python ansible_adhoc.py

PLAY [configure web service]***********************************************
*******
TASK [Gathering Facts]*****************************************************
*******
ok: [node2.tedu.cn]
ok: [node3.tedu.cn]
TASK [install web app]*****************************************************
*******
ok: [node3.tedu.cn] =&gt; (item=[u‘httpd’， u‘php’， u‘php-mysql
’])
.........
.........
</pre></div></div>
      <a name="case5">
      </a>
      <h2>5 案例5：ansible模块开发</h2>
      <h3>5.1 问题</h3>
      <p>修改构建工程，要求如下：</p>
      <ol class="list">
        <li>编写ansible模块，使用shutil模块拷贝文件
</li>
        <li>数据源用变量名yuan
</li>
        <li>数据目标变量用mudi
</li>
      </ol>
      <h3>5.2 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一：编写脚本</p>
      <p>创建模块路径</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># mkdir mylib</li><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># cd mylib</li><li>#设置ansible查找模块的路径</li><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># <span class="sh_keyword">export</span> ANSIBLE_LIBRARY<span class="sh_symbol">=</span>$<span class="sh_symbol">(</span>pwd<span class="sh_symbol">)/</span>mylib</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost myansi]# mkdir mylib
[root@localhost myansi]# cd mylib
#设置ansible查找模块的路径
[root@localhost myansi]# export ANSIBLE_LIBRARY=$(pwd)/mylib
</pre></div></div>
      <p>创建模块，模块用于将管理机上的文件拷贝到目标主机的指定目录</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost mylib<span class="sh_symbol">]</span># vim <span class="sh_normal">mylib</span><span class="sh_symbol">/</span>rcopy<span class="sh_symbol">.</span>py</li><li>#<span class="sh_symbol">!</span><span class="sh_regexp">/usr/</span><span class="sh_normal">bin</span><span class="sh_symbol">/</span>env python</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost mylib]# vim mylib/rcopy.py
#!/usr/bin/env python
</pre></div></div>
      <p>导入所需要的模块</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li>import shutil</li><li>from ansible<span class="sh_symbol">.</span>module_utils<span class="sh_symbol">.</span>basic import AnsibleModule</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">import shutil
from ansible.module_utils.basic import AnsibleModule
</pre></div></div>
      <p>创建模块入口</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li>def <span class="sh_function">main</span><span class="sh_symbol">():</span></li><li>##使用AnsibleModule类中的argument_spec来接收yuan、mudi两个参数，参数必须提供并且是字符串类型</li><li>    mokuai <span class="sh_symbol">=</span> <span class="sh_function">AnsibleModule</span><span class="sh_symbol">(</span></li><li>        argument_spec<span class="sh_symbol">=</span><span class="sh_function">dict</span><span class="sh_symbol">(</span></li><li>            yuan<span class="sh_symbol">=</span><span class="sh_function">dict</span><span class="sh_symbol">(</span>required<span class="sh_symbol">=</span>True<span class="sh_symbol">,</span> type<span class="sh_symbol">=</span><span class="sh_string">'str'</span><span class="sh_symbol">),</span></li><li>            mudi<span class="sh_symbol">=</span><span class="sh_function">dict</span><span class="sh_symbol">(</span>required<span class="sh_symbol">=</span>True<span class="sh_symbol">,</span> type<span class="sh_symbol">=</span><span class="sh_string">'str'</span><span class="sh_symbol">)</span></li><li>        <span class="sh_symbol">)</span></li><li>    <span class="sh_symbol">)</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">def main():
##使用AnsibleModule类中的argument_spec来接收yuan、mudi两个参数，参数必须提供并且是字符串类型
    mokuai = AnsibleModule(
        argument_spec=dict(
            yuan=dict(required=True, type='str'),
            mudi=dict(required=True, type='str')
        )
    )
</pre></div></div>
      <p>执行动作</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li>#将yuan拷贝到mudi</li><li>    shutil<span class="sh_symbol">.</span><span class="sh_function">copy</span><span class="sh_symbol">(</span>mokuai<span class="sh_symbol">.</span>params<span class="sh_symbol">[</span><span class="sh_string">'yuan'</span><span class="sh_symbol">],</span> mokuai<span class="sh_symbol">.</span>params<span class="sh_symbol">[</span><span class="sh_string">'mudi'</span><span class="sh_symbol">])</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">#将yuan拷贝到mudi
    shutil.copy(mokuai.params['yuan'], mokuai.params['mudi'])
</pre></div></div>
      <p>返回结果</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li>#拷贝完成后，返回json数据</li><li>    mokuai<span class="sh_symbol">.</span><span class="sh_function">exit_json</span><span class="sh_symbol">(</span>change<span class="sh_symbol">=</span>True<span class="sh_symbol">)</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">#拷贝完成后，返回json数据
    mokuai.exit_json(change=True)
</pre></div></div>
      <p>编写主程序代码</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/LINUX/NSDTN201801/DEVOPS/DAY06/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_keyword">if</span> __name__ <span class="sh_symbol">==</span> <span class="sh_string">'__main__'</span><span class="sh_symbol">:</span></li><li>    <span class="sh_function">main</span><span class="sh_symbol">()</span></li><li><span class="sh_symbol">[</span>root@localhost myansi<span class="sh_symbol">]</span># ansible dbservers <span class="sh_symbol">-</span>m rcopy <span class="sh_symbol">-</span>a <span class="sh_string">"yuan=/etc/hosts mudi=/opt"</span></li><li>node1<span class="sh_symbol">.</span>tedu<span class="sh_symbol">.</span>cn <span class="sh_symbol">|</span> SUCCESS <span class="sh_symbol">=&gt;</span> <span class="sh_cbracket">{</span></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;“change”<span class="sh_symbol">:</span> <span class="sh_keyword">true</span>，</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;“changed”<span class="sh_symbol">:</span> <span class="sh_keyword">false</span></li><li><span class="sh_cbracket">}</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">if __name__ == '__main__':
    main()
[root@localhost myansi]# ansible dbservers -m rcopy -a "yuan=/etc/hosts mudi=/opt"
node1.tedu.cn | SUCCESS =&gt; {
		“change”: true，
		“changed”: false
}
</pre></div></div>
    </div>
  
</body></html>